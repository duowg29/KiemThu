name: Katalon Tests CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  run-katalon-tests:
    name: Run Katalon Runtime Engine (KRE) Tests
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Katalon Tests with KRE
      timeout-minutes: 30
      env:
        JAVA_OPTS: '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true'
        KATALON_OPTS: '-noSplash -consoleLog'
        KATALON_API_KEY: ${{ secrets.KATALON_API_KEY }}  # Set KATALON_API_KEY in GitHub Secrets (Settings → Secrets → Actions)
      run: |
        # Đường dẫn KRE (Katalon Runtime Engine)
        $KRE_HOME = "E:\App\Katalon_Studio_Engine_Windows_64-10.4.2"
        
        Write-Host "=========================================="
        Write-Host "Using Katalon Runtime Engine (KRE)"
        Write-Host "KRE Path: $KRE_HOME"
        Write-Host "=========================================="
        
        # Kiểm tra KRE có tồn tại không
        if (-not (Test-Path $KRE_HOME)) {
          Write-Host "ERROR: KRE not found at $KRE_HOME" -ForegroundColor Red
          Write-Host "Please verify the KRE installation path." -ForegroundColor Red
          exit 1
        }
        
        # Tìm executable của KRE (có thể là katalonc.exe hoặc katalonc)
        $katalonExe = $null
        $possibleExes = @(
          "$KRE_HOME\katalonc.exe",
          "$KRE_HOME\katalonc",
          "$KRE_HOME\katalon.exe"
        )
        
        foreach ($exe in $possibleExes) {
          if (Test-Path $exe) {
            $katalonExe = $exe
            Write-Host "Found KRE executable: $katalonExe" -ForegroundColor Green
            break
          }
        }
        
        if (-not $katalonExe) {
          Write-Host "ERROR: KRE executable not found in $KRE_HOME" -ForegroundColor Red
          Write-Host "Searched for:" -ForegroundColor Yellow
          $possibleExes | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
          Write-Host ""
          Write-Host "Available files in KRE directory:" -ForegroundColor Yellow
          Get-ChildItem -Path $KRE_HOME -File | Select-Object -First 10 | ForEach-Object {
            Write-Host "  - $($_.Name)" -ForegroundColor Gray
          }
          exit 1
        }
        
        Write-Host "Using KRE executable: $katalonExe" -ForegroundColor Green
        
        # Kiểm tra license activation
        # KRE cần license activation - có thể dùng API key hoặc offline license
        $katalonApiKey = $env:KATALON_API_KEY
        $offlineLicensePath = "$env:USERPROFILE\.katalon\license"
        
        Write-Host ""
        Write-Host "Checking license activation..." -ForegroundColor Yellow
        if ($katalonApiKey) {
          Write-Host "Using API key for license activation" -ForegroundColor Green
        } elseif (Test-Path $offlineLicensePath) {
          $licenseFiles = Get-ChildItem -Path $offlineLicensePath -File -ErrorAction SilentlyContinue
          if ($licenseFiles) {
            Write-Host "Found offline license files in: $offlineLicensePath" -ForegroundColor Green
            $licenseFiles | ForEach-Object {
              Write-Host "  - $($_.Name)" -ForegroundColor Gray
            }
          } else {
            Write-Host "WARNING: License folder exists but no license files found" -ForegroundColor Yellow
            Write-Host "KRE will attempt to activate but may fail without API key or valid license" -ForegroundColor Yellow
          }
        } else {
          Write-Host "WARNING: No API key or offline license found" -ForegroundColor Yellow
          Write-Host "KRE requires license activation. Options:" -ForegroundColor Yellow
          Write-Host "  1. Set KATALON_API_KEY in GitHub Secrets" -ForegroundColor Yellow
          Write-Host "  2. Place offline license files in: $offlineLicensePath" -ForegroundColor Yellow
          Write-Host "KRE will attempt to run but may fail with activation error" -ForegroundColor Yellow
        }
        Write-Host ""
        
        # Test suite và paths
        # QUAN TRỌNG: Đảm bảo test suite path đúng với tên trong project
        $testSuitePath = "Test Suites/Funtctional/Shopping Cart Testcases"
        # Đảm bảo project path là absolute path
        $projectPath = (Resolve-Path $PWD).Path -replace '\\', '/'
        $reportFolder = "$PWD\Reports" -replace '\\', '/'
        $baseUrl = "http://localhost/CAMNEST/"
        
        Write-Host ""
        Write-Host "Current working directory: $PWD" -ForegroundColor Cyan
        Write-Host "Resolved project path: $projectPath" -ForegroundColor Cyan
        
        # Validate project path
        if (-not (Test-Path $projectPath)) {
          Write-Host "ERROR: Project path does not exist: $projectPath" -ForegroundColor Red
          Write-Host "Current directory: $PWD" -ForegroundColor Yellow
          exit 1
        }
        
        # Kiểm tra project file (.prj) - QUAN TRỌNG cho KRE
        $projectFile = Get-ChildItem -Path $projectPath -Filter "*.prj" -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $projectFile) {
          Write-Host "ERROR: No .prj file found in project directory: $projectPath" -ForegroundColor Red
          Write-Host "KRE requires a valid Katalon project with .prj file" -ForegroundColor Red
          Write-Host "Available files in project directory:" -ForegroundColor Yellow
          Get-ChildItem -Path $projectPath -File | Select-Object -First 10 | ForEach-Object {
            Write-Host "  - $($_.Name)" -ForegroundColor Gray
          }
          exit 1
        } else {
          Write-Host "Found project file: $($projectFile.Name)" -ForegroundColor Green
        }
        
        # Tìm test suite file (có thể có hoặc không có extension .ts)
        $testSuiteFullPath = Join-Path $projectPath $testSuitePath
        $testSuiteWithExt = "$testSuiteFullPath.ts"
        
        # Kiểm tra với extension .ts trước
        if (Test-Path $testSuiteWithExt) {
          $testSuiteFullPath = $testSuiteWithExt
          Write-Host "Found test suite with .ts extension: $testSuiteFullPath"
        } elseif (Test-Path $testSuiteFullPath) {
          Write-Host "Found test suite without extension: $testSuiteFullPath"
        } else {
          Write-Host "ERROR: Test suite path does not exist: $testSuiteFullPath" -ForegroundColor Red
          Write-Host "Also checked: $testSuiteWithExt" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "Available test suites in project:" -ForegroundColor Yellow
          $testSuitesDir = Join-Path $projectPath "Test Suites"
          if (Test-Path $testSuitesDir) {
            $allTestSuites = Get-ChildItem -Path $testSuitesDir -Recurse -Filter "*.ts" -ErrorAction SilentlyContinue
            if ($allTestSuites) {
              Write-Host "Found $($allTestSuites.Count) test suite(s):" -ForegroundColor Cyan
              $allTestSuites | ForEach-Object {
                $relativePath = $_.FullName.Replace($projectPath, '').TrimStart('\', '/')
                # Remove .ts extension for display
                $displayPath = $relativePath -replace '\.ts$', ''
                Write-Host "  - $displayPath" -ForegroundColor Gray
              }
              Write-Host ""
              Write-Host "Please update testSuitePath in workflow to one of the above paths." -ForegroundColor Yellow
            } else {
              Write-Host "  No test suites found in Test Suites directory" -ForegroundColor Yellow
            }
          } else {
            Write-Host "  Test Suites directory not found" -ForegroundColor Yellow
          }
          exit 1
        }
        
        # Format test suite path cho KRE (relative path, không có extension .ts)
        # KRE yêu cầu path không có extension
        $testSuitePathFormatted = $testSuitePath -replace '\\', '/'
        if ($testSuitePathFormatted.EndsWith('.ts')) {
          $testSuitePathFormatted = $testSuitePathFormatted.Substring(0, $testSuitePathFormatted.Length - 3)
        }
        
        # Tạo thư mục Reports
        if (-not (Test-Path "Reports")) {
          New-Item -ItemType Directory -Path "Reports" -Force | Out-Null
        }
        
        Write-Host "=========================================="
        Write-Host "Running KRE tests..."
        Write-Host "Project: $projectPath"
        Write-Host "Test Suite: $testSuitePathFormatted"
        Write-Host "Test Suite File Path: $testSuiteFullPath"
        Write-Host "KRE Executable: $katalonExe"
        Write-Host "Report Folder: $reportFolder"
        Write-Host "Base URL: $baseUrl"
        Write-Host "=========================================="
        
        # Set environment variables trước khi chạy (đảm bảo headless)
        # QUAN TRỌNG: Thêm system property để Test Listener biết đang chạy headless
        # Suppress AI bundle warnings và disable javax annotations
        $env:JAVA_OPTS = '-Djava.awt.headless=true -Dkatalon.browser.type=Chrome (headless) -Dorg.eclipse.swt.browser.DefaultType=none -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true -Declipse.e4.inject.javax.warning=false'
        $env:KATALON_OPTS = '-noSplash -consoleLog'
        
        Write-Host "Environment variables set:"
        Write-Host "JAVA_OPTS: $env:JAVA_OPTS"
        Write-Host "KATALON_OPTS: $env:KATALON_OPTS"
        Write-Host ""
        
        # Xây dựng lệnh KRE
        # KRE có thể cần workspace riêng hoặc dùng @noDefault
        # Thử dùng @noDefault trước, nếu không được thì dùng workspace path
        $tempWorkspace = Join-Path $projectPath ".katalon-workspace"
        if (-not (Test-Path $tempWorkspace)) {
            New-Item -ItemType Directory -Path $tempWorkspace -Force | Out-Null
            Write-Host "Created workspace directory: $tempWorkspace" -ForegroundColor Green
        }
        
        # KRE arguments - thử dùng -data @noDefault trước
        # QUAN TRỌNG: Test suite path có khoảng trắng - KRE yêu cầu path không có quotes
        # Nhưng khi join arguments, PowerShell sẽ tự động xử lý spaces
        $katalonArgs = @(
          '-data', '@noDefault'  # Dùng @noDefault để tránh workspace conflicts
          '-runMode=console'
          '-console'
          '-noSplash'
          '-consoleLog'
          "-projectPath=$projectPath"
          "-testSuitePath=$testSuitePathFormatted"  # Path với spaces - PowerShell sẽ tự động quote khi join
          '-executionProfile=default'
          '-browserType=Chrome (headless)'
          "-g_baseUrl=$baseUrl"
          "-reportFolder=$reportFolder"
          '-retry=0'
        )
        
        Write-Host "DEBUG: Test suite path formatted: '$testSuitePathFormatted'" -ForegroundColor Cyan
        Write-Host "DEBUG: Arguments before join:" -ForegroundColor Cyan
        $katalonArgs | ForEach-Object { Write-Host "  [$_]" -ForegroundColor Gray }
        
        # Thêm API key nếu có
        if ($katalonApiKey) {
          $katalonArgs += "-apiKey=$katalonApiKey"
          Write-Host "Added API key to KRE arguments" -ForegroundColor Green
        }
        
        Write-Host "Starting KRE execution..."
        Write-Host "Note: This may take a while on slower machines. Please wait..."
        Write-Host ""
        
        # Chuyển đến thư mục project trước khi chạy
        Push-Location $projectPath
        
        try {
          Write-Host "Launching KRE process from: $projectPath"
          Write-Host "Executable: $katalonExe"
          Write-Host "Arguments: $($katalonArgs -join ' ')"
          Write-Host ""
          Write-Host "Starting KRE execution (headless mode)..."
          Write-Host "This may take a while on slower machines. Please wait..."
          Write-Host ""
          
          # Thử cách đơn giản hơn trước: chạy trực tiếp với & để xem output ngay
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Attempting direct execution to capture immediate output..." -ForegroundColor Yellow
          
          $directOutput = @()
          $directErrors = @()
          $directExitCode = $null
          
          try {
            # Chạy trực tiếp để xem output ngay
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Executing KRE directly..." -ForegroundColor Green
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Command: $katalonExe $($katalonArgs -join ' ')" -ForegroundColor Gray
            Write-Host ""
            
            # Capture output
            $script:output = New-Object System.Collections.ArrayList
            $script:errors = New-Object System.Collections.ArrayList
            
            # Chạy và capture tất cả output (cả stdout và stderr)
            # KRE là headless nên không cần lo về GUI
            # QUAN TRỌNG: Build arguments string thủ công để xử lý spaces đúng cách
            $argumentsString = $katalonArgs | ForEach-Object {
              if ($_ -match '^-[^=]+=') {
                # Argument có format -key=value
                $key, $value = $_ -split '=', 2
                if ($value -match '\s') {
                  # Value có spaces, cần quote
                  "$key=`"$value`""
                } else {
                  $_
                }
              } else {
                # Argument đơn giản
                $_
              }
            } | ForEach-Object { $_ }
            
            $processInfo = New-Object System.Diagnostics.ProcessStartInfo
            $processInfo.FileName = $katalonExe
            $processInfo.Arguments = $argumentsString -join ' '
            
            Write-Host "[DEBUG] Final arguments string: $($processInfo.Arguments)" -ForegroundColor Cyan
            $processInfo.UseShellExecute = $false
            $processInfo.RedirectStandardOutput = $true
            $processInfo.RedirectStandardError = $true
            $processInfo.CreateNoWindow = $true
            $processInfo.WindowStyle = [System.Diagnostics.ProcessWindowStyle]::Hidden
            $processInfo.WorkingDirectory = $projectPath
            
            # Set environment variables
            $processInfo.EnvironmentVariables['JAVA_OPTS'] = $env:JAVA_OPTS
            $processInfo.EnvironmentVariables['KATALON_OPTS'] = $env:KATALON_OPTS
            
            $process = New-Object System.Diagnostics.Process
            $process.StartInfo = $processInfo
            
            # Capture output
            $outputBuilder = New-Object System.Text.StringBuilder
            $errorBuilder = New-Object System.Text.StringBuilder
            
            $outputEvent = Register-ObjectEvent -InputObject $process -EventName OutputDataReceived -Action {
                if ($EventArgs.Data) {
                    $line = $EventArgs.Data
                    [void]$Event.MessageData.AppendLine($line)
                    # QUAN TRỌNG: Hiển thị output real-time để biết process đang làm gì
                    Write-Host "[$(Get-Date -Format 'HH:mm:ss')] $line" -ForegroundColor Cyan
                }
            } -MessageData $outputBuilder
            
            $errorEvent = Register-ObjectEvent -InputObject $process -EventName ErrorDataReceived -Action {
                if ($EventArgs.Data) {
                    $line = $EventArgs.Data
                    [void]$Event.MessageData.AppendLine($line)
                    # QUAN TRỌNG: Hiển thị errors real-time
                    Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ERROR: $line" -ForegroundColor Red
                }
            } -MessageData $errorBuilder
            
            $process.Start() | Out-Null
            $process.BeginOutputReadLine()
            $process.BeginErrorReadLine()
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process started (PID: $($process.Id))" -ForegroundColor Green
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Waiting for output (this may take 1-2 minutes for KRE to initialize)..." -ForegroundColor Yellow
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] KRE is loading project and initializing. Please wait..." -ForegroundColor Yellow
            
            # KRE không có GUI nên không cần monitor GUI processes
            
            # Monitor process với status updates
            $startTime = Get-Date
            $lastStatusTime = Get-Date
            $noOutputTimeout = 300  # 5 phút không có output = có thể treo
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Monitoring process (checking every 10 seconds)..." -ForegroundColor Yellow
            
            while (-not $process.HasExited) {
                $elapsed = (Get-Date) - $startTime
                $elapsedSeconds = [int]$elapsed.TotalSeconds
                
                # Kiểm tra timeout tổng (30 phút)
                if ($elapsedSeconds -ge 1800) {
                    Write-Host "[$(Get-Date -Format 'HH:mm:ss')] TIMEOUT: Process exceeded 30 minutes" -ForegroundColor Red
                    $process.Kill()
                    break
                }
                
                # Status update mỗi 30 giây
                $timeSinceLastStatus = (Get-Date) - $lastStatusTime
                if ($timeSinceLastStatus.TotalSeconds -ge 30) {
                    $minutes = [int]($elapsed.TotalMinutes)
                    $seconds = [int]($elapsed.TotalSeconds % 60)
                    $outputCount = ($outputBuilder.ToString() -split "`n").Count
                    $errorCount = ($errorBuilder.ToString() -split "`n").Count
                    Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Status: Still running... (Elapsed: ${minutes}m ${seconds}s, PID: $($process.Id), Output lines: $outputCount, Error lines: $errorCount)" -ForegroundColor Gray
                    
                    # QUAN TRỌNG: Hiển thị errors ngay nếu có
                    if ($errorCount -gt 0) {
                        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WARNING: Found $errorCount error line(s)! Displaying errors:" -ForegroundColor Yellow
                        $currentErrors = ($errorBuilder.ToString() -split "`n") | Where-Object { $null -ne $_ -and $_.Trim() -ne '' }
                        $currentErrors | ForEach-Object {
                            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ERROR: $_" -ForegroundColor Red
                        }
                    }
                    
                    $lastStatusTime = Get-Date
                    
                    # Kiểm tra child processes
                    try {
                        $allProcesses = Get-Process -ErrorAction SilentlyContinue
                        $childProcesses = $allProcesses | Where-Object {
                            try {
                                $_.Parent.Id -eq $process.Id
                            } catch {
                                $false  # Ignore errors when accessing Parent property
                            }
                        }
                        if ($childProcesses) {
                            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Found $($childProcesses.Count) child process(es)" -ForegroundColor Cyan
                        }
                    } catch {
                        # Ignore errors
                    }
                }
                
                Start-Sleep -Seconds 10
            }
            
            # Đợi một chút để capture output cuối cùng
            Start-Sleep -Seconds 2
            
            if (-not $process.HasExited) {
                Write-Host "[WARNING] Process timeout, killing..." -ForegroundColor Yellow
                $process.Kill()
                $directExitCode = 1
            } else {
                $directExitCode = $process.ExitCode
            }
            
            # Lấy output
            $allDirectOutput = $outputBuilder.ToString() -split "`n"
            $allDirectErrors = $errorBuilder.ToString() -split "`n"
            
            # QUAN TRỌNG: Hiển thị errors ngay sau khi process exit
            if ($allDirectErrors -and $allDirectErrors.Count -gt 0) {
                Write-Host ""
                Write-Host "========================================" -ForegroundColor Red
                Write-Host "ERRORS FOUND ($($allDirectErrors.Count) lines):" -ForegroundColor Red
                Write-Host "========================================" -ForegroundColor Red
                $allDirectErrors | Where-Object { $null -ne $_ -and $_.Trim() -ne '' } | ForEach-Object {
                    Write-Host "[ERROR] $_" -ForegroundColor Red
                }
                Write-Host "========================================" -ForegroundColor Red
                Write-Host ""
            }
            
            # Cleanup events
            Unregister-Event -SourceIdentifier $outputEvent.Name -ErrorAction SilentlyContinue
            Unregister-Event -SourceIdentifier $errorEvent.Name -ErrorAction SilentlyContinue
            
            # Phân loại output - xử lý từng dòng
            if ($allDirectOutput) {
              foreach ($line in $allDirectOutput) {
                if ($null -ne $line -and $line.Trim() -ne '') {
                  [void]$script:output.Add($line)
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] $line"
                }
              }
            }
            
            # Xử lý errors
            if ($allDirectErrors) {
              foreach ($line in $allDirectErrors) {
                if ($null -ne $line -and $line.Trim() -ne '') {
                  [void]$script:errors.Add($line)
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ERROR: $line" -ForegroundColor Red
                }
              }
            }
            
            if ($null -eq $directExitCode) {
              $directExitCode = 0
            }
            
            $exitCode = $directExitCode
            
            Write-Host ""
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Direct execution completed with exit code: $exitCode" -ForegroundColor Green
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Output lines: $($script:output.Count), Error lines: $($script:errors.Count)" -ForegroundColor Gray
            
            # Nếu không có output nhưng có exit code lỗi, cảnh báo
            if ($script:output.Count -eq 0 -and $exitCode -ne 0) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WARNING: No output captured but exit code is $exitCode" -ForegroundColor Yellow
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] This might indicate KRE failed to start or output was not captured" -ForegroundColor Yellow
            }
            
          } catch {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Direct execution exception: $($_.Exception.Message)" -ForegroundColor Yellow
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Trying Start-Process method as fallback..." -ForegroundColor Yellow
            
            # Fallback: Dùng Start-Process với CreateNoWindow
            # Build arguments string với proper escaping cho spaces
            $argumentsString = $katalonArgs | ForEach-Object {
              if ($_ -match '^-[^=]+=') {
                $key, $value = $_ -split '=', 2
                if ($value -match '\s') {
                  "$key=`"$value`""
                } else {
                  $_
                }
              } else {
                $_
              }
            }
            
            $processInfo = New-Object System.Diagnostics.ProcessStartInfo
            $processInfo.FileName = $katalonExe
            $processInfo.Arguments = $argumentsString -join ' '
            $processInfo.UseShellExecute = $false
            $processInfo.RedirectStandardOutput = $true
            $processInfo.RedirectStandardError = $true
            $processInfo.CreateNoWindow = $true
            $processInfo.WorkingDirectory = $projectPath
            
            # Set environment variables
            $processInfo.EnvironmentVariables['JAVA_OPTS'] = $env:JAVA_OPTS
            $processInfo.EnvironmentVariables['KATALON_OPTS'] = $env:KATALON_OPTS
            
            $process = New-Object System.Diagnostics.Process
            $process.StartInfo = $processInfo
            
            # Capture output real-time
            $script:output = New-Object System.Collections.ArrayList
            $script:errors = New-Object System.Collections.ArrayList
            $script:lastOutputTime = Get-Date
            
            # Event handlers để capture output real-time
            $outputHandler = {
              param($sender, $e)
              if ($e.Data) {
                $line = $e.Data
                [void]$script:output.Add($line)
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] $line" -ForegroundColor Cyan
                $script:lastOutputTime = Get-Date
              }
            }
            
            $errorHandler = {
              param($sender, $e)
              if ($e.Data) {
                $line = $e.Data
                [void]$script:errors.Add($line)
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ERROR: $line" -ForegroundColor Red
                $script:lastOutputTime = Get-Date
              }
            }
            
            $process.add_OutputDataReceived($outputHandler)
            $process.add_ErrorDataReceived($errorHandler)
            
            # Bắt đầu process
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Starting KRE process..." -ForegroundColor Green
            
            try {
              $process.Start() | Out-Null
            } catch {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ERROR: Failed to start process" -ForegroundColor Red
              Write-Host "Exception: $($_.Exception.Message)" -ForegroundColor Red
              throw
            }
            
            $process.BeginOutputReadLine()
            $process.BeginErrorReadLine()
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process started (PID: $($process.Id))" -ForegroundColor Green
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Waiting for initial output (10 seconds)..." -ForegroundColor Yellow
            
            # Đợi một chút để xem có output ban đầu không
            Start-Sleep -Seconds 10
            
            # Kiểm tra xem process có còn chạy không
            if ($process.HasExited) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WARNING: Process exited very quickly (within 10 seconds)" -ForegroundColor Yellow
              $exitCode = $process.ExitCode
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Exit code: $exitCode" -ForegroundColor Yellow
            } else {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process is still running. Monitoring..." -ForegroundColor Green
              Write-Host ""
              
              # Monitor process với timeout và progress updates
              $timeoutMinutes = 25
              $timeoutSeconds = $timeoutMinutes * 60
              $startTime = Get-Date
              $lastStatusTime = Get-Date
              $noOutputTimeout = 300  # 5 phút không có output = có thể treo
              
              while (-not $process.HasExited) {
                $elapsed = (Get-Date) - $startTime
                $elapsedSeconds = [int]$elapsed.TotalSeconds
                
                # Kiểm tra timeout tổng
                if ($elapsedSeconds -ge $timeoutSeconds) {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] TIMEOUT: Process exceeded $timeoutMinutes minutes" -ForegroundColor Red
                  $process.Kill()
                  $exitCode = 1
                  break
                }
                
                # Kiểm tra timeout không có output
                $timeSinceLastOutput = (Get-Date) - $script:lastOutputTime
                if ($timeSinceLastOutput.TotalSeconds -ge $noOutputTimeout) {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WARNING: No output for $noOutputTimeout seconds. Process may be hung." -ForegroundColor Yellow
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process is still running (PID: $($process.Id)). Checking if it's responsive..." -ForegroundColor Yellow
                }
                
                # Status update mỗi 30 giây
                $timeSinceLastStatus = (Get-Date) - $lastStatusTime
                if ($timeSinceLastStatus.TotalSeconds -ge 30) {
                  $minutes = [int]($elapsed.TotalMinutes)
                  $seconds = [int]($elapsed.TotalSeconds % 60)
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Status: Still running... (Elapsed: ${minutes}m ${seconds}s, PID: $($process.Id), Output lines: $($script:output.Count))" -ForegroundColor Gray
                  $lastStatusTime = Get-Date
                }
                
                Start-Sleep -Seconds 2
              }
              
              # Đợi một chút để capture output cuối cùng
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process exited. Waiting for final output (5 seconds)..." -ForegroundColor Yellow
              Start-Sleep -Seconds 5
              
              if (-not $process.HasExited) {
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process did not exit properly. Forcing termination..." -ForegroundColor Red
                $process.Kill()
                $exitCode = 1
              } else {
                $exitCode = $process.ExitCode
                $elapsed = (Get-Date) - $startTime
                $minutes = [int]($elapsed.TotalMinutes)
                $seconds = [int]($elapsed.TotalSeconds % 60)
                Write-Host ""
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process completed (Exit code: $exitCode, Duration: ${minutes}m ${seconds}s)" -ForegroundColor Green
              }
            }
            
            # Đảm bảo output được flush
            Start-Sleep -Seconds 2
            
            # Nếu exit code null, set về 0
            if ($null -eq $exitCode) {
              $exitCode = 0
            }
            
            # Hiển thị summary
            Write-Host ""
            Write-Host "=== EXECUTION SUMMARY ===" -ForegroundColor Cyan
            Write-Host "Output lines captured: $($script:output.Count)"
            Write-Host "Error lines captured: $($script:errors.Count)"
            Write-Host "Exit code: $exitCode"
            Write-Host ""
            
          # Hiển thị output nếu có
          if ($script:output.Count -gt 0) {
            Write-Host "=== KRE OUTPUT (ALL $($script:output.Count) lines) ===" -ForegroundColor Cyan
            $script:output | ForEach-Object {
              Write-Host $_
            }
          } else {
            Write-Host "WARNING: No output captured from KRE!" -ForegroundColor Yellow
            Write-Host "This might indicate:" -ForegroundColor Yellow
            Write-Host "  1. Process exited too quickly" -ForegroundColor Yellow
            Write-Host "  2. Output was not redirected properly" -ForegroundColor Yellow
            Write-Host "  3. KRE failed to start" -ForegroundColor Yellow
            Write-Host ""
            Write-Host "Attempting to check KRE logs..." -ForegroundColor Yellow
            
            # Kiểm tra log files của KRE
            $logPaths = @(
              "$projectPath\Logs",
              "$env:USERPROFILE\.katalon\logs",
              "$KRE_HOME\configuration\org.eclipse.osgi",
              "$env:USERPROFILE\.katalon\workspace\.metadata\.log"
            )
            
            foreach ($logPath in $logPaths) {
              if (Test-Path $logPath) {
                Write-Host "Checking: $logPath" -ForegroundColor Gray
                $logFiles = Get-ChildItem -Path $logPath -Recurse -Filter "*.log" -ErrorAction SilentlyContinue | 
                            Sort-Object LastWriteTime -Descending | 
                            Select-Object -First 3
                if ($logFiles) {
                  Write-Host "Found log files:" -ForegroundColor Green
                  foreach ($logFile in $logFiles) {
                    Write-Host "  - $($logFile.FullName) (Modified: $($logFile.LastWriteTime))" -ForegroundColor Green
                    try {
                      $logContent = Get-Content $logFile.FullName -Tail 30 -ErrorAction SilentlyContinue
                      if ($logContent) {
                        Write-Host "  Last 30 lines:" -ForegroundColor Cyan
                        $logContent | ForEach-Object { Write-Host "    $_" -ForegroundColor Gray }
                      }
                    } catch {
                      Write-Host "  Could not read log file" -ForegroundColor Yellow
                    }
                  }
                }
              }
            }
          }
            
            if ($script:errors.Count -gt 0) {
              Write-Host ""
              Write-Host "========================================" -ForegroundColor Red
              Write-Host "=== ALL ERRORS CAPTURED ($($script:errors.Count) lines) ===" -ForegroundColor Red
              Write-Host "========================================" -ForegroundColor Red
              $script:errors | ForEach-Object {
                Write-Host "ERROR: $_" -ForegroundColor Red
              }
              Write-Host "========================================" -ForegroundColor Red
              Write-Host ""
              Write-Host "These errors may indicate:" -ForegroundColor Yellow
              Write-Host "  1. KRE configuration issues" -ForegroundColor Yellow
              Write-Host "  2. Project/test suite problems" -ForegroundColor Yellow
              Write-Host "  3. Missing dependencies or files" -ForegroundColor Yellow
              Write-Host "  4. Browser/Chrome driver issues" -ForegroundColor Yellow
              Write-Host ""
            }
            
            # Nếu exit code 2, hiển thị thông tin thêm
            if ($exitCode -eq 2) {
              Write-Host ""
              Write-Host "=== EXIT CODE 2 ANALYSIS ===" -ForegroundColor Yellow
              Write-Host "Exit code 2 typically means:" -ForegroundColor Yellow
              Write-Host "  - Configuration/Project error" -ForegroundColor Yellow
              Write-Host "  - Invalid project path or test suite path" -ForegroundColor Yellow
              Write-Host "  - Missing required files or dependencies" -ForegroundColor Yellow
              Write-Host ""
              Write-Host "Please check:" -ForegroundColor Yellow
              Write-Host "  1. Project path: $projectPath" -ForegroundColor Yellow
              Write-Host "  2. Test suite path: $testSuitePathFormatted" -ForegroundColor Yellow
              Write-Host "  3. KRE executable: $katalonExe" -ForegroundColor Yellow
              Write-Host "  4. Check if project file (.prj) exists" -ForegroundColor Yellow
            }
            
            # Để tương thích với code phía dưới
            $outputLines = $script:output
            $errorLines = $script:errors
          } # End of catch block for direct execution fallback
          
        } catch {
          Write-Host ""
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ERROR: Exception occurred while running KRE" -ForegroundColor Red
          Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
          Write-Host "Exception Type: $($_.Exception.GetType().FullName)" -ForegroundColor Red
          Write-Host "Script Stack Trace:" -ForegroundColor Red
          Write-Host $_.ScriptStackTrace -ForegroundColor Red
          if ($_.Exception.InnerException) {
            Write-Host "Inner Exception: $($_.Exception.InnerException.Message)" -ForegroundColor Red
          }
          $exitCode = 1
        } finally {
          # Quay lại thư mục ban đầu
          Pop-Location
        }
        
        # Đảm bảo biến tồn tại cho code phía dưới
        if (-not (Get-Variable -Name 'outputLines' -ErrorAction SilentlyContinue)) {
          $outputLines = @()
        }
        if (-not (Get-Variable -Name 'errorLines' -ErrorAction SilentlyContinue)) {
          $errorLines = @()
        }
        
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "KRE execution finished"
        Write-Host "Exit code: $exitCode"
        Write-Host "=========================================="
        
        # Hiển thị output và error nếu có
        if ($outputLines.Count -gt 0) {
          Write-Host ""
          Write-Host "=== KRE OUTPUT (last 50 lines) ===" -ForegroundColor Cyan
          $outputLines | Select-Object -Last 50 | ForEach-Object { Write-Host $_ }
        }
        
        if ($errorLines.Count -gt 0) {
          Write-Host ""
          Write-Host "=== KRE ERRORS ===" -ForegroundColor Red
          $errorLines | ForEach-Object { Write-Host $_ -ForegroundColor Red }
        }
        
        # Kiểm tra log files của KRE
        $logDirs = @(
          "$projectPath\Logs",
          "$env:USERPROFILE\.katalon\logs",
          "$KRE_HOME\configuration\org.eclipse.osgi"
        )
        
        foreach ($logDir in $logDirs) {
          if (Test-Path $logDir) {
            Write-Host ""
            Write-Host "Checking for log files in: $logDir" -ForegroundColor Cyan
            $logFiles = Get-ChildItem -Path $logDir -Recurse -Filter "*.log" -ErrorAction SilentlyContinue | 
                        Sort-Object LastWriteTime -Descending | 
                        Select-Object -First 5
            if ($logFiles) {
              Write-Host "Found log files:" -ForegroundColor Yellow
              foreach ($logFile in $logFiles) {
                Write-Host "  - $($logFile.FullName) (Modified: $($logFile.LastWriteTime))"
                # Hiển thị 20 dòng cuối của log file
                try {
                  $logContent = Get-Content $logFile.FullName -Tail 20 -ErrorAction SilentlyContinue
                  if ($logContent) {
                    Write-Host "  Last 20 lines:" -ForegroundColor Gray
                    $logContent | ForEach-Object { Write-Host "    $_" -ForegroundColor Gray }
                  }
                } catch {
                  Write-Host "  Could not read log file" -ForegroundColor Yellow
                }
              }
            }
          }
        }
        
        # Kiểm tra kết quả và phân tích reports
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "ANALYZING TEST RESULTS"
        Write-Host "=========================================="
        
        # Kiểm tra xem có reports không
        if (Test-Path "Reports") {
          $reportFiles = Get-ChildItem -Path "Reports" -Recurse -File
          Write-Host ""
          Write-Host "Found $($reportFiles.Count) report file(s):" -ForegroundColor Cyan
          
          # Tìm HTML report để phân tích
          $htmlReports = $reportFiles | Where-Object { $_.Extension -eq '.html' -and $_.Name -eq 'report.html' }
          if ($htmlReports) {
            $htmlReport = $htmlReports | Select-Object -First 1
            Write-Host ""
            Write-Host "Main HTML Report: $($htmlReport.FullName)" -ForegroundColor Green
          }
          
          # Tìm JUnit report để phân tích
          $junitReports = $reportFiles | Where-Object { $_.Name -eq 'JUnit_Report.xml' }
          if ($junitReports) {
            $junitReport = $junitReports | Select-Object -First 1
            Write-Host "JUnit Report: $($junitReport.FullName)" -ForegroundColor Green
            
            # Đọc JUnit report để lấy test results
            try {
              [xml]$junitXml = Get-Content $junitReport.FullName -ErrorAction SilentlyContinue
              if ($junitXml) {
                $testsuites = $junitXml.testsuites
                if ($testsuites) {
                  $totalTests = $testsuites.tests
                  $failures = $testsuites.failures
                  $errors = $testsuites.errors
                  $skipped = $testsuites.skipped
                  
                  Write-Host ""
                  Write-Host "Test Results Summary:" -ForegroundColor Cyan
                  Write-Host "  Total Tests: $totalTests" -ForegroundColor $(if ($failures -eq 0 -and $errors -eq 0) { "Green" } else { "Yellow" })
                  Write-Host "  Failures: $failures" -ForegroundColor $(if ($failures -eq 0) { "Green" } else { "Red" })
                  Write-Host "  Errors: $errors" -ForegroundColor $(if ($errors -eq 0) { "Green" } else { "Red" })
                  Write-Host "  Skipped: $skipped" -ForegroundColor Yellow
                  
                  if ($failures -gt 0 -or $errors -gt 0) {
                    Write-Host ""
                    Write-Host "NOTE: Exit code 1 is expected when tests fail." -ForegroundColor Yellow
                    Write-Host "This is normal behavior - tests ran but some failed." -ForegroundColor Yellow
                    
                    # Hiển thị chi tiết các test failures
                    Write-Host ""
                    Write-Host "=== DETAILED TEST FAILURES ===" -ForegroundColor Red
                    try {
                      $testCases = $junitXml.SelectNodes("//testcase")
                      foreach ($testCase in $testCases) {
                        $failureNode = $testCase.SelectSingleNode("failure")
                        $errorNode = $testCase.SelectSingleNode("error")
                        if ($failureNode -or $errorNode) {
                          $testName = $testCase.name
                          $className = $testCase.classname
                          Write-Host ""
                          Write-Host "Test: $testName" -ForegroundColor Yellow
                          Write-Host "Class: $className" -ForegroundColor Gray
                          if ($failureNode) {
                            $failureMsg = $failureNode.message
                            Write-Host "Failure Message: $failureMsg" -ForegroundColor Red
                            $failureText = $failureNode.'#text'
                            if ($failureText) {
                              $failureLines = ($failureText -split "`n") | Select-Object -First 10
                              Write-Host "Failure Details (first 10 lines):" -ForegroundColor Red
                              $failureLines | ForEach-Object { Write-Host "  $_" -ForegroundColor Gray }
                            }
                          }
                          if ($errorNode) {
                            $errorMsg = $errorNode.message
                            Write-Host "Error Message: $errorMsg" -ForegroundColor Red
                            $errorText = $errorNode.'#text'
                            if ($errorText) {
                              $errorLines = ($errorText -split "`n") | Select-Object -First 10
                              Write-Host "Error Details (first 10 lines):" -ForegroundColor Red
                              $errorLines | ForEach-Object { Write-Host "  $_" -ForegroundColor Gray }
                            }
                          }
                        }
                      }
                    } catch {
                      Write-Host "Could not parse detailed failure information: $($_.Exception.Message)" -ForegroundColor Yellow
                    }
                    Write-Host "==============================" -ForegroundColor Red
                  }
                }
              }
            } catch {
              Write-Host "Could not parse JUnit report: $($_.Exception.Message)" -ForegroundColor Yellow
            }
          }
        } else {
          Write-Host ""
          Write-Host "WARNING: Reports folder not found or empty" -ForegroundColor Yellow
        }
        
        # Phân tích exit code
        Write-Host ""
        Write-Host "=========================================="
        if ($exitCode -eq 0) {
          Write-Host "SUCCESS: Tests completed successfully with KRE" -ForegroundColor Green
          Write-Host "Exit code: $exitCode (Success)" -ForegroundColor Green
        } elseif ($exitCode -eq 1) {
          Write-Host "EXIT CODE 1: Tests executed but may have failures or warnings" -ForegroundColor Yellow
          Write-Host "Exit code 1 can mean:" -ForegroundColor Yellow
          Write-Host "  - Some test cases failed (check reports above)" -ForegroundColor Yellow
          Write-Host "  - Warnings from KRE (e.g., AI bundle warnings - can be ignored)" -ForegroundColor Yellow
          Write-Host "  - General execution issues" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "Check the reports above for detailed test results." -ForegroundColor Cyan
        } elseif ($exitCode -eq 2) {
          Write-Host "ERROR: KRE exited with code $exitCode (Configuration/Project error)" -ForegroundColor Red
          Write-Host "Common causes:" -ForegroundColor Yellow
          Write-Host "  - Invalid project path or test suite path" -ForegroundColor Yellow
          Write-Host "  - Missing required files or dependencies" -ForegroundColor Yellow
          Write-Host "  - Project configuration issues" -ForegroundColor Yellow
        } elseif ($exitCode -eq 3) {
          Write-Host "ERROR: KRE exited with code $exitCode (Test execution error)" -ForegroundColor Red
        } else {
          Write-Host "ERROR: KRE exited with code $exitCode" -ForegroundColor Red
        }
        Write-Host "=========================================="
        
        # Exit với code tương ứng
        # QUAN TRỌNG: 
        # - Exit code 0: Success (all tests passed)
        # - Exit code 1: Tests executed but had failures (workflow should fail)
        # - Exit code 2: Configuration/Project error (workflow should fail)
        # - Exit code 3: Test execution error (workflow should fail)
        
        # Kiểm tra xem có test failures thực sự không
        $hasTestFailures = $false
        if (Test-Path "Reports") {
          $junitReports = Get-ChildItem -Path "Reports" -Recurse -Filter "JUnit_Report.xml" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($junitReports) {
            try {
              [xml]$junitXml = Get-Content $junitReports.FullName -ErrorAction SilentlyContinue
              if ($junitXml -and $junitXml.testsuites) {
                $failures = $junitXml.testsuites.failures
                $errors = $junitXml.testsuites.errors
                if (($failures -and [int]$failures -gt 0) -or ($errors -and [int]$errors -gt 0)) {
                  $hasTestFailures = $true
                }
              }
            } catch {
              # Ignore parsing errors
            }
          }
        }
        
        if ($exitCode -eq 1 -and -not $hasTestFailures) {
          Write-Host ""
          Write-Host "NOTE: Exit code 1 but no test failures detected in reports." -ForegroundColor Yellow
          Write-Host "This might be due to warnings (e.g., AI bundle warnings)." -ForegroundColor Yellow
          Write-Host "Treating as success since tests executed and reports were generated." -ForegroundColor Yellow
          exit 0
        } elseif ($exitCode -eq 1 -and $hasTestFailures) {
          Write-Host ""
          Write-Host "Tests executed but had failures. Exiting with code 1." -ForegroundColor Red
          exit 1
        } else {
          # Exit với code tương ứng (0, 2, 3, etc.)
          exit $exitCode
        }
          
    - name: Format and Prepare Excel Report
      if: always()
      run: |
        Write-Host "=========================================="
        Write-Host "Formatting CSV report for Excel"
        Write-Host "=========================================="
        
        # Tìm file report.csv chính
        $csvFiles = Get-ChildItem -Path "Reports" -Recurse -Filter "*.csv" -ErrorAction SilentlyContinue
        $mainCsv = $csvFiles | Where-Object { $_.Name -eq 'report.csv' } | Select-Object -First 1
        
        if (-not $mainCsv) {
          Write-Host "WARNING: No report.csv found in Reports folder" -ForegroundColor Yellow
          exit 0
        }
        
        Write-Host "Found CSV report: $($mainCsv.FullName)" -ForegroundColor Green
        
        # Đọc và format CSV với UTF-8 BOM cho Excel
        try {
          Write-Host "Reading CSV report..." -ForegroundColor Cyan
          
          # Đọc file - thử nhiều encoding
          $content = $null
          $encodings = @('UTF8', 'Unicode', 'Default')
          
          foreach ($enc in $encodings) {
            try {
              $testContent = Get-Content $mainCsv.FullName -Encoding $enc -ErrorAction Stop
              if ($testContent -and $testContent.Count -gt 0) {
                $content = $testContent
                Write-Host "Read with encoding: $enc ($($content.Count) lines)" -ForegroundColor Green
                break
              }
            } catch {
              continue
            }
          }
          
          if (-not $content) {
            # Fallback: đọc raw bytes
            $bytes = [System.IO.File]::ReadAllBytes($mainCsv.FullName)
            $utf8 = [System.Text.Encoding]::UTF8
            $content = $utf8.GetString($bytes) -split "`r?`n"
            Write-Host "Read as raw bytes and decoded as UTF-8" -ForegroundColor Yellow
          }
          
          # Tạo CSV mới với UTF-8 BOM (Excel sẽ hiểu đúng encoding và tiếng Việt)
          $outputCsv = Join-Path "Reports" "test-results-formatted.csv"
          
          # UTF-8 với BOM cho Excel
          $utf8WithBom = New-Object System.Text.UTF8Encoding $true
          $writer = New-Object System.IO.StreamWriter($outputCsv, $false, $utf8WithBom)
          
          # Viết lại từng dòng (giữ nguyên format nhưng đảm bảo encoding đúng)
          foreach ($line in $content) {
            if (-not [string]::IsNullOrWhiteSpace($line)) {
              $writer.WriteLine($line)
            }
          }
          
          $writer.Close()
          
          Write-Host "Created formatted CSV: $outputCsv" -ForegroundColor Green
          $fileSize = (Get-Item $outputCsv).Length
          Write-Host "File size: $([math]::Round($fileSize / 1KB, 2)) KB" -ForegroundColor Gray
          
          # Verify UTF-8 BOM
          $bytes = [System.IO.File]::ReadAllBytes($outputCsv)
          if ($bytes.Length -ge 3 -and $bytes[0] -eq 0xEF -and $bytes[1] -eq 0xBB -and $bytes[2] -eq 0xBF) {
            Write-Host "UTF-8 BOM encoding: OK (Excel will display correctly)" -ForegroundColor Green
          } else {
            Write-Host "Warning: UTF-8 BOM not detected" -ForegroundColor Yellow
          }
          
        } catch {
          Write-Host "ERROR: Failed to format CSV report" -ForegroundColor Red
          Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red
          
          # Fallback: copy và convert encoding
          try {
            $outputCsv = Join-Path "Reports" "test-results-formatted.csv"
            $utf8WithBom = New-Object System.Text.UTF8Encoding $true
            $originalContent = Get-Content $mainCsv.FullName -Raw -Encoding UTF8
            [System.IO.File]::WriteAllText($outputCsv, $originalContent, $utf8WithBom)
            Write-Host "Created fallback CSV with UTF-8 BOM" -ForegroundColor Yellow
          } catch {
            Write-Host "Failed to create fallback CSV" -ForegroundColor Red
          }
        }
        
    - name: Upload Formatted CSV Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-excel
        path: Reports/test-results-formatted.csv
        if-no-files-found: warn
        retention-days: 30
