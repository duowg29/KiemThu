name: Katalon Tests CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Cho phép chạy thủ công
  schedule:
    # Chạy mỗi ngày lúc 2:00 AM UTC (9:00 AM giờ Việt Nam)
    # Format: minute hour day-of-month month day-of-week
    # Để chạy 1 ngày 1 lần, uncomment dòng dưới:
    - cron: '0 2 * * *'  # 2:00 AM UTC mỗi ngày
    
    # Các ví dụ khác:
    # - cron: '0 9 * * *'  # 9:00 AM UTC mỗi ngày (4:00 PM giờ Việt Nam)
    # - cron: '0 0 * * *'  # Nửa đêm UTC mỗi ngày (7:00 AM giờ Việt Nam)
    # - cron: '0 14 * * 1-5'  # 2:00 PM UTC từ thứ 2 đến thứ 6 (9:00 PM giờ Việt Nam)
    # - cron: '0 */6 * * *'  # Mỗi 6 giờ một lần

jobs:
  run-katalon-tests:
    name: Run Katalon Studio Tests
    runs-on: self-hosted  # YÊU CẦU: Phải có self-hosted runner đã setup
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Katalon Tests
      timeout-minutes: 30
      env:
        JAVA_OPTS: '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dorg.eclipse.swt.browser.noDefault=true -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true'
        KATALON_OPTS: '-noSplash -noExit -consoleLog'
      run: |
        # Thay đổi đường dẫn này theo đường dẫn Katalon Studio trên runner của bạn
        # Option 1: Nếu cài trong Program Files
        # $KATALON_HOME_ORIGINAL = "$env:ProgramFiles\Katalon\Katalon Studio"
        
        # Option 2: Nếu cài trong user directory (uncomment dòng này và comment dòng trên)
         $KATALON_HOME_ORIGINAL = "$env:USERPROFILE\.katalon\packages\KSE-10.4.2"
        
        # Option 3: Nếu dùng đường dẫn tùy chỉnh (uncomment và sửa)
        # $KATALON_HOME_ORIGINAL = "C:\Path\To\Katalon\Studio"
        
        if (-not (Test-Path "$KATALON_HOME_ORIGINAL\katalon.exe")) {
          Write-Host "Katalon Studio not found at $KATALON_HOME_ORIGINAL"
          Write-Host "Please install Katalon Studio or use self-hosted runner with Katalon pre-installed"
          Write-Host "Or update the KATALON_HOME path in this workflow file"
          exit 1
        }
        
        # Kiểm tra độ dài đường dẫn để tránh lỗi "path too long"
        $fullPath = "$KATALON_HOME_ORIGINAL\katalon.exe"
        $pathLength = $fullPath.Length
        
        Write-Host "Original Katalon path length: $pathLength characters"
        Write-Host "Original path: $KATALON_HOME_ORIGINAL"
        
        # Nếu đường dẫn quá dài (>200 ký tự), tạo symbolic link ngắn hơn
        $KATALON_HOME = $KATALON_HOME_ORIGINAL
        if ($pathLength -gt 200) {
          Write-Host "WARNING: Path is too long ($pathLength chars). Creating symbolic link..."
          
          # Tạo symbolic link với đường dẫn ngắn hơn
          $shortPath = "C:\KS"
          $symlinkPath = "$shortPath\KSE-10.4.2"
          
          # Xóa symlink cũ nếu có
          if (Test-Path $symlinkPath) {
            Remove-Item $symlinkPath -Force -ErrorAction SilentlyContinue
          }
          
          # Tạo thư mục cha nếu chưa có
          if (-not (Test-Path $shortPath)) {
            New-Item -ItemType Directory -Path $shortPath -Force | Out-Null
          }
          
          # Tạo symbolic link (cần quyền admin hoặc Developer Mode)
          try {
            # Thử dùng cmd để tạo symlink (không cần admin nếu có Developer Mode)
            $cmd = "cmd /c mklink /D `"$symlinkPath`" `"$KATALON_HOME_ORIGINAL`""
            Invoke-Expression $cmd | Out-Null
            
            if (Test-Path "$symlinkPath\katalon.exe") {
              $KATALON_HOME = $symlinkPath
              Write-Host "Symbolic link created successfully: $symlinkPath -> $KATALON_HOME_ORIGINAL"
              Write-Host "New path length: $($symlinkPath.Length) characters"
            } else {
              Write-Host "WARNING: Symbolic link creation may have failed. Using original path."
              Write-Host "If you see 'path too long' error, please:"
              Write-Host "  1. Enable Windows Developer Mode, OR"
              Write-Host "  2. Run PowerShell as Administrator, OR"
              Write-Host "  3. Move Katalon to a shorter path (e.g., C:\KS\KSE-10.4.2)"
            }
          } catch {
            Write-Host "WARNING: Could not create symbolic link: $($_.Exception.Message)"
            Write-Host "Using original path. If you see 'path too long' error, please move Katalon to a shorter path."
          }
        }
        
        Write-Host "Running Katalon Studio tests..."
        Write-Host "Katalon path: $KATALON_HOME\katalon.exe"
        Write-Host "Project path: $PWD"
        Write-Host "Note: Project path is automatically set to workspace directory where runner checkout code"
        
        # Dùng test suite cụ thể thay vì collection (collection có thể không chạy được trong console mode)
        $testSuitePath = "Test Suites/UI/Login Testcases"
        
        # Kiểm tra test suite có tồn tại không
        if (-not (Test-Path "$PWD\$testSuitePath.ts")) {
          Write-Host "WARNING: Test suite file not found at $PWD\$testSuitePath.ts"
          Write-Host "Trying alternative path..."
          # Thử không có extension
          if (Test-Path "$PWD\$testSuitePath") {
            Write-Host "Found test suite without extension"
          } else {
            Write-Host "Listing available test suites:"
            Get-ChildItem -Path "$PWD\Test Suites" -Recurse -Filter "*.ts" | Where-Object { $_.Name -notlike "*Testing.ts" } | ForEach-Object {
              Write-Host "  $($_.FullName.Replace($PWD, '.'))"
            }
            Write-Host "NOTE: Test suite collections (*Testing.ts) may not work in console mode."
            Write-Host "Use specific test suites instead (e.g., Login Testcases, Signup Testcases)"
          }
        } else {
          Write-Host "Test suite found: $PWD\$testSuitePath.ts"
          
          # Kiểm tra test suite có test cases không
          $tsContent = Get-Content "$PWD\$testSuitePath.ts" -Raw
          $testCaseCount = ([regex]::Matches($tsContent, '<testCaseId>')).Count
          Write-Host "Found $testCaseCount test case(s) in test suite"
          
          if ($testCaseCount -eq 0) {
            Write-Host "WARNING: Test suite has no test cases!"
            Write-Host "This may be why tests are not running."
          }
        }
        
        Write-Host "Starting Katalon execution..."
        $startTime = Get-Date
        
        # Đảm bảo thư mục Reports tồn tại
        if (-not (Test-Path "Reports")) {
          New-Item -ItemType Directory -Path "Reports" -Force | Out-Null
        }
        
        # Chạy Katalon với format path đúng (dùng forward slash cho test suite path)
        Write-Host "Executing Katalon..."
        Write-Host "This may take several minutes. Please wait..."
        Write-Host "Project: $PWD"
        Write-Host "Test Suite: $testSuitePath"
        
        # Chuyển đổi path sang format Katalon yêu cầu (forward slash)
        $testSuitePathFormatted = $testSuitePath -replace '\\', '/'
        $projectPathFormatted = $PWD -replace '\\', '/'
        $reportFolderFormatted = "$PWD\Reports" -replace '\\', '/'
        
        Write-Host "Formatted Test Suite Path: $testSuitePathFormatted"
        
        # Chạy Katalon trực tiếp với & operator (không dùng Start-Process)
        Write-Host "Executing Katalon command..."
        Write-Host "Command: $KATALON_HOME\katalon.exe -runMode=console -projectPath=`"$projectPathFormatted`" -retry=0 -testSuitePath=`"$testSuitePathFormatted`" -executionProfile=default -browserType=`"Chrome (headless)`" -apiKey= -g_username= -g_password= -reportFolder=`"$reportFolderFormatted`""
        
        # Đảm bảo environment variables được set
        $env:JAVA_OPTS = '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dorg.eclipse.swt.browser.noDefault=true -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true'
        $env:KATALON_OPTS = '-noSplash -noExit -consoleLog'
        
        Write-Host "Environment variables set:"
        Write-Host "  JAVA_OPTS: $env:JAVA_OPTS"
        Write-Host "  KATALON_OPTS: $env:KATALON_OPTS"
        
        Write-Host "Starting Katalon execution (this may take several minutes)..."
        Write-Host "=========================================="
        
        # Kiểm tra xem có katalonc.exe không (console-only version)
        $katalonExe = "$KATALON_HOME\katalon.exe"
        if (Test-Path "$KATALON_HOME\katalonc.exe") {
          $katalonExe = "$KATALON_HOME\katalonc.exe"
          Write-Host "Using katalonc.exe (console-only version)"
        } else {
          Write-Host "Using katalon.exe (will force console mode)"
        }
        
        # Chạy Katalon trực tiếp và capture output
        Write-Host "Executing: $katalonExe"
        
        # Set base URL for testing - Chạy trên localhost
        $baseUrl = "http://localhost/CAMNEST/"
        Write-Host "=========================================="
        Write-Host "CONFIGURATION:"
        Write-Host "  Base URL: $baseUrl"
        Write-Host "  Execution Profile: default"
        Write-Host "  Browser: Chrome (headless)"
        Write-Host "=========================================="
        
        # Kiểm tra profile có URL đúng không
        $profilePath = "$PWD\Profiles\default.glbl"
        if (Test-Path $profilePath) {
          $profileContent = Get-Content $profilePath -Raw
          if ($profileContent -match [regex]::Escape($baseUrl)) {
            Write-Host "✓ Profile default contains correct URL"
          } else {
            Write-Host "WARNING: Profile default may not contain the expected URL"
            Write-Host "Profile content preview:"
            Get-Content $profilePath | Select-Object -First 10 | ForEach-Object { Write-Host "  $_" }
          }
        }
        
        Write-Host "Starting Katalon with URL: $baseUrl"
        Write-Host "=========================================="
        
        try {
          # Chạy Katalon trực tiếp với & operator để tránh mở GUI
          Write-Host "Executing Katalon in console mode (no GUI)..."
          Write-Host "=========================================="
          
          # Đảm bảo environment variables được set trước khi chạy
          $env:JAVA_OPTS = '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dorg.eclipse.swt.browser.noDefault=true -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true -Dswt.autoKey=false'
          $env:KATALON_OPTS = '-noSplash -noExit -consoleLog'
          
          # Chạy Katalon trực tiếp với & operator và capture output
          # Redirect cả stdout và stderr
          & $katalonExe `
            -runMode=console `
            -console `
            -noSplash `
            -projectPath="$projectPathFormatted" `
            -retry=0 `
            -testSuitePath="$testSuitePathFormatted" `
            -executionProfile=default `
            -browserType="Chrome (headless)" `
            -apiKey="" `
            -g_username="" `
            -g_password="" `
            -g_baseUrl="$baseUrl" `
            -reportFolder="$reportFolderFormatted" `
            *>&1 | Tee-Object -FilePath "katalon-output.txt"
          
          # Lấy exit code
          $exitCode = $LASTEXITCODE
          
          if ($null -eq $exitCode) {
            $exitCode = 0
          }
          
          Write-Host "=========================================="
          Write-Host "Katalon process completed with exit code: $exitCode"
          
          # Đọc và hiển thị output
          if (Test-Path "katalon-output.txt") {
            Write-Host "=== Last 100 lines of Katalon Output ==="
            $outputLines = Get-Content "katalon-output.txt" -Tail 100 -ErrorAction SilentlyContinue
            if ($outputLines) {
              $outputLines | ForEach-Object { Write-Host $_ }
            }
          }
          
        } catch {
          Write-Host "Error executing Katalon: $($_.Exception.Message)"
          Write-Host "Stack trace: $($_.Exception.StackTrace)"
          $exitCode = 1
        }
        
        Write-Host "=========================================="
        
        $endTime = Get-Date
        $duration = $endTime - $startTime
        
        Write-Host "=========================================="
        $durationSeconds = [math]::Round($duration.TotalSeconds, 2)
        Write-Host "Katalon execution completed in $durationSeconds seconds"
        Write-Host "Exit code: $exitCode"
        Write-Host "=========================================="
        
        # Đọc và hiển thị output
        if (Test-Path "katalon-stdout.txt") {
          Write-Host "=== Katalon Standard Output ==="
          $stdout = Get-Content "katalon-stdout.txt" -ErrorAction SilentlyContinue
          if ($stdout) {
            $stdout | ForEach-Object { Write-Host $_ }
          } else {
            Write-Host "(empty)"
          }
        }
        
        if (Test-Path "katalon-stderr.txt") {
          Write-Host "=== Katalon Standard Error ==="
          $stderr = Get-Content "katalon-stderr.txt" -ErrorAction SilentlyContinue
          if ($stderr) {
            $stderr | ForEach-Object { Write-Host $_ }
          }
        }
        
        # Set để dùng sau
        $global:LASTEXITCODE = $exitCode
        
        # Kiểm tra nếu chạy quá nhanh (có thể test không chạy)
        if ($duration.TotalSeconds -lt 10) {
          $durationSeconds = [math]::Round($duration.TotalSeconds, 2)
          Write-Host "WARNING: Test completed too quickly ($durationSeconds seconds)."
          Write-Host "This may indicate that tests did not actually run."
          Write-Host "Possible reasons:"
          Write-Host "  1. Test suite path is incorrect"
          Write-Host "  2. Test suite has no test cases"
          Write-Host "  3. Katalon failed to start properly"
          Write-Host "Check the output and error files above for details."
        }
          
        if ($exitCode -ne 0) {
          Write-Host "Tests failed with exit code $exitCode"
          # Không exit ngay, để tìm reports trước
        }
        
        Write-Host "Finding test reports..."
        Write-Host "Current directory: $PWD"
        
        # Tạo thư mục Reports nếu chưa có
        if (-not (Test-Path "Reports")) {
          New-Item -ItemType Directory -Path "Reports" -Force | Out-Null
          Write-Host "Created Reports directory"
        }
        
        # Tìm tất cả reports trong project và workspace
        Write-Host "Searching for reports in project directory..."
        Get-ChildItem -Path $PWD -Recurse -Directory -Filter "Reports" -ErrorAction SilentlyContinue | ForEach-Object {
          Write-Host "Found Reports folder at: $($_.FullName)"
          $files = Get-ChildItem -Path $_.FullName -Recurse -File -ErrorAction SilentlyContinue
          Write-Host "  Found $($files.Count) files"
        }
        
        # Tìm trong thư mục workspace của runner (có thể Katalon tạo reports ở đó)
        $workspacePath = $env:GITHUB_WORKSPACE
        if ($workspacePath) {
          Write-Host "Searching in workspace: $workspacePath"
          Get-ChildItem -Path $workspacePath -Recurse -Directory -Filter "Reports" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "Found Reports in workspace at: $($_.FullName)"
          }
        }
        
        # List tất cả files trong Reports
        if (Test-Path "Reports") {
          Write-Host "Contents of Reports folder:"
          $reportFiles = Get-ChildItem -Path "Reports" -Recurse -ErrorAction SilentlyContinue
          if ($reportFiles.Count -eq 0) {
            Write-Host "  (empty)"
          } else {
            $reportFiles | ForEach-Object {
              Write-Host "  $($_.FullName)"
            }
          }
        } else {
          Write-Host "Reports folder not found in project root"
        }
        
        # Tìm reports trong thư mục Katalon workspace (reports thường được tạo ở đó)
        $katalonWorkspace = "$env:USERPROFILE\.katalon\packages\KSE-10.4.2\workspace"
        Write-Host "Searching for reports in Katalon workspace: $katalonWorkspace"
        
        if (Test-Path $katalonWorkspace) {
          # Tìm project folder trong workspace (thường là tên project hoặc hash)
          $projectFolders = Get-ChildItem -Path $katalonWorkspace -Directory -ErrorAction SilentlyContinue
          foreach ($projFolder in $projectFolders) {
            Write-Host "Checking project folder: $($projFolder.FullName)"
            
            # Tìm Reports trong project folder
            $reportDirs = Get-ChildItem -Path $projFolder.FullName -Recurse -Directory -Filter "Reports" -ErrorAction SilentlyContinue
            foreach ($reportDir in $reportDirs) {
              Write-Host "Found Reports at: $($reportDir.FullName)"
              $reportFiles = Get-ChildItem -Path $reportDir.FullName -Recurse -File -ErrorAction SilentlyContinue
              Write-Host "  Found $($reportFiles.Count) report files"
              
              if ($reportFiles.Count -gt 0) {
                # Copy tất cả reports về project
                Copy-Item -Path "$($reportDir.FullName)\*" -Destination "Reports\" -Recurse -Force -ErrorAction SilentlyContinue
                Write-Host "Copied $($reportFiles.Count) report files to project Reports folder"
              }
            }
            
            # Tìm reports trong thư mục execution (Katalon có thể tạo reports ở đó)
            $executionDirs = Get-ChildItem -Path $projFolder.FullName -Directory -Filter "*execution*" -ErrorAction SilentlyContinue
            foreach ($execDir in $executionDirs) {
              $execReports = Get-ChildItem -Path $execDir.FullName -Recurse -Directory -Filter "Reports" -ErrorAction SilentlyContinue
              foreach ($execReport in $execReports) {
                Write-Host "Found Reports in execution folder: $($execReport.FullName)"
                Copy-Item -Path "$($execReport.FullName)\*" -Destination "Reports\" -Recurse -Force -ErrorAction SilentlyContinue
              }
            }
          }
        }
        
        # Tìm reports mới nhất trong workspace (theo timestamp)
        $allReports = Get-ChildItem -Path $katalonWorkspace -Recurse -File -Filter "*.html" -ErrorAction SilentlyContinue | Where-Object { $_.LastWriteTime -gt $startTime }
        if ($allReports) {
          Write-Host "Found $($allReports.Count) HTML report files created after test start"
          $latestReportDir = $allReports | Sort-Object LastWriteTime -Descending | Select-Object -First 1 | ForEach-Object { $_.DirectoryName }
          if ($latestReportDir) {
            Write-Host "Copying reports from: $latestReportDir"
            Copy-Item -Path "$latestReportDir\*" -Destination "Reports\" -Recurse -Force -ErrorAction SilentlyContinue
          }
        }
        
        # Nếu vẫn không có reports, tạo report mới
        if (-not (Test-Path "Reports") -or (Get-ChildItem -Path "Reports" -Recurse -ErrorAction SilentlyContinue).Count -eq 0) {
          Write-Host "No reports found. Creating new report..."
          
          # Đảm bảo thư mục Reports tồn tại
          if (-not (Test-Path "Reports")) {
            New-Item -ItemType Directory -Path "Reports" -Force | Out-Null
          }
          
          # Tạo file report HTML (dùng cách đơn giản để tránh lỗi YAML)
          $status = if ($exitCode -eq 0) { "PASSED" } else { "FAILED" }
          $statusClass = if ($exitCode -eq 0) { "success" } else { "failure" }
          $durationStr = [math]::Round($duration.TotalSeconds, 2).ToString()
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          $startTimeStr = $startTime.ToString("yyyy-MM-dd HH:mm:ss")
          $endTimeStr = $endTime.ToString("yyyy-MM-dd HH:mm:ss")
          
          $htmlContent = '<!DOCTYPE html><html><head><title>Katalon Test Report</title><style>body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5}.container{max-width:1200px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}h1{color:#333;border-bottom:3px solid #4CAF50;padding-bottom:10px}.summary{display:flex;gap:20px;margin:20px 0}.card{flex:1;padding:15px;border-radius:5px}.success{background:#d4edda;border-left:4px solid #28a745}.failure{background:#f8d7da;border-left:4px solid #dc3545}.info{background:#d1ecf1;border-left:4px solid #17a2b8}.label{font-weight:bold;color:#666}.value{font-size:24px;margin-top:5px}.details{margin-top:20px}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd}th{background:#f8f9fa;font-weight:bold}.timestamp{color:#666;font-size:14px}</style></head><body><div class="container"><h1>Katalon Test Execution Report</h1><div class="timestamp">Generated: ' + $timestamp + '</div><div class="summary"><div class="card ' + $statusClass + '"><div class="label">Status</div><div class="value">' + $status + '</div></div><div class="card info"><div class="label">Duration</div><div class="value">' + $durationStr + 's</div></div><div class="card info"><div class="label">Exit Code</div><div class="value">' + $exitCode + '</div></div></div><div class="details"><h2>Execution Details</h2><table><tr><th>Property</th><th>Value</th></tr><tr><td>Test Suite</td><td>' + $testSuitePath + '</td></tr><tr><td>Project Path</td><td>' + $PWD + '</td></tr><tr><td>Katalon Version</td><td>10.4.2</td></tr><tr><td>Browser</td><td>Chrome (headless)</td></tr><tr><td>Execution Profile</td><td>default</td></tr><tr><td>Start Time</td><td>' + $startTimeStr + '</td></tr><tr><td>End Time</td><td>' + $endTimeStr + '</td></tr></table></div><div class="details"><h2>Notes</h2><p>This report was automatically generated by GitHub Actions workflow.</p></div></div></body></html>'
          
          $htmlContent | Out-File -FilePath "Reports\test-report.html" -Encoding UTF8
          Write-Host "Created report: Reports\test-report.html"
          
          # Tạo file report JSON
          $reportData = @{
            status = $status
            exitCode = $exitCode
            duration = [math]::Round($duration.TotalSeconds, 2)
            testSuite = $testSuitePath
            projectPath = $PWD
            startTime = $startTimeStr
            endTime = $endTimeStr
            browser = "Chrome (headless)"
            executionProfile = "default"
            timestamp = $timestamp
          }
          $reportData | ConvertTo-Json -Depth 10 | Out-File -FilePath "Reports\test-report.json" -Encoding UTF8
          Write-Host "Created report: Reports\test-report.json"
          
          # Tạo file summary text
          $summaryText = "KATALON TEST EXECUTION REPORT`n==============================`n`nStatus: $status`nExit Code: $exitCode`nDuration: $durationStr seconds`n`nTest Suite: $testSuitePath`nProject Path: $PWD`nBrowser: Chrome (headless)`nExecution Profile: default`n`nStart Time: $startTimeStr`nEnd Time: $endTimeStr`n`nGenerated: $timestamp"
          $summaryText | Out-File -FilePath "Reports\test-summary.txt" -Encoding UTF8
          Write-Host "Created report: Reports\test-summary.txt"
          
          Write-Host "Reports created successfully!"
        }
          
    - name: Upload Test Reports and Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          Reports/**
          **/Reports/**
          **/*.html
          **/*.xml
          **/*.json
          katalon-stdout.txt
          katalon-stderr.txt
        if-no-files-found: warn
        retention-days: 30

