name: Katalon Tests CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  run-katalon-tests:
    name: Run Katalon Studio Tests
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Katalon Tests
      timeout-minutes: 30
      env:
        JAVA_OPTS: '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true -Djava.awt.headless=true'
        KATALON_OPTS: '-noSplash -consoleLog -noExit'
        DISPLAY: ':0'
      run: |
        # Đường dẫn Katalon
        $KATALON_HOME = "$env:USERPROFILE\.katalon\packages\KSE-10.4.2"
        
        if (-not (Test-Path "$KATALON_HOME\katalon.exe")) {
          Write-Host "Katalon not found at $KATALON_HOME"
          exit 1
        }
        
        # Ưu tiên dùng katalonc.exe (console-only, không mở GUI)
        $katalonExe = "$KATALON_HOME\katalonc.exe"
        if (-not (Test-Path $katalonExe)) {
          Write-Host "katalonc.exe not found, using katalon.exe instead"
          $katalonExe = "$KATALON_HOME\katalon.exe"
        } else {
          Write-Host "Using katalonc.exe (console-only mode)"
        }
        
        # Test suite và paths
        $testSuitePath = "Test Suites/UI/Navigation Testcases"
        $projectPath = $PWD -replace '\\', '/'
        $reportFolder = "$PWD\Reports" -replace '\\', '/'
        $baseUrl = "http://localhost/CAMNEST/"
        
        # Validate project path
        if (-not (Test-Path $projectPath)) {
          Write-Host "ERROR: Project path does not exist: $projectPath" -ForegroundColor Red
          exit 1
        }
        
        # Tìm test suite file (có thể có hoặc không có extension .ts)
        $testSuiteFullPath = Join-Path $projectPath $testSuitePath
        $testSuiteWithExt = "$testSuiteFullPath.ts"
        
        # Kiểm tra với extension .ts trước
        if (Test-Path $testSuiteWithExt) {
          $testSuiteFullPath = $testSuiteWithExt
          Write-Host "Found test suite with .ts extension: $testSuiteFullPath"
        } elseif (Test-Path $testSuiteFullPath) {
          Write-Host "Found test suite without extension: $testSuiteFullPath"
        } else {
          Write-Host "ERROR: Test suite path does not exist: $testSuiteFullPath" -ForegroundColor Red
          Write-Host "Also checked: $testSuiteWithExt" -ForegroundColor Yellow
          Write-Host "Available test suites:" -ForegroundColor Yellow
          $testSuitesDir = Join-Path $projectPath "Test Suites"
          if (Test-Path $testSuitesDir) {
            Get-ChildItem -Path $testSuitesDir -Recurse -Filter "*.ts" | ForEach-Object {
              $relativePath = $_.FullName.Replace($projectPath, '').TrimStart('\', '/')
              Write-Host "  - $relativePath"
            }
          }
          exit 1
        }
        
        # Format test suite path cho Katalon (relative path, không có extension .ts)
        # Katalon yêu cầu path không có extension
        $testSuitePathFormatted = $testSuitePath -replace '\\', '/'
        if ($testSuitePathFormatted.EndsWith('.ts')) {
          $testSuitePathFormatted = $testSuitePathFormatted.Substring(0, $testSuitePathFormatted.Length - 3)
        }
        
        # Validate project file
        $projectFile = Join-Path $projectPath "*.prj"
        $prjFiles = Get-ChildItem -Path $projectFile -ErrorAction SilentlyContinue
        if (-not $prjFiles) {
          Write-Host "WARNING: No .prj file found in project directory" -ForegroundColor Yellow
        } else {
          Write-Host "Found project file: $($prjFiles[0].Name)"
        }
        
        # Tạo thư mục Reports
        if (-not (Test-Path "Reports")) {
          New-Item -ItemType Directory -Path "Reports" -Force | Out-Null
        }
        
        Write-Host "=========================================="
        Write-Host "Running Katalon tests..."
        Write-Host "Project: $projectPath"
        Write-Host "Test Suite (for Katalon): $testSuitePathFormatted"
        Write-Host "Test Suite File Path: $testSuiteFullPath"
        Write-Host "Katalon Executable: $katalonExe"
        Write-Host "Report Folder: $reportFolder"
        Write-Host "Base URL: $baseUrl"
        Write-Host "=========================================="
        
        # Set environment variables trước khi chạy (đảm bảo headless)
        $env:JAVA_OPTS = '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true'
        $env:KATALON_OPTS = '-noSplash -consoleLog -noExit'
        
        Write-Host "Environment variables set:"
        Write-Host "JAVA_OPTS: $env:JAVA_OPTS"
        Write-Host "KATALON_OPTS: $env:KATALON_OPTS"
        Write-Host ""
        
        # Xây dựng lệnh Katalon
        # Lưu ý: ProcessStartInfo.Arguments cần format đúng, không cần quote nếu dùng array
        $katalonArgs = @(
          '-runMode=console',
          '-console',
          '-noSplash',
          '-consoleLog',
          "-projectPath=$projectPath",
          "-testSuitePath=$testSuitePathFormatted",
          '-executionProfile=default',
          '-browserType=Chrome (headless)',
          "-g_baseUrl=$baseUrl",
          "-reportFolder=$reportFolder",
          '-retry=0'
        )
        
        Write-Host "Starting Katalon execution..."
        Write-Host "Note: This may take a while on slower machines. Please wait..."
        Write-Host ""
        
        # Chuyển đến thư mục project trước khi chạy
        Push-Location $projectPath
        
        try {
          # Chạy Katalon trực tiếp với & operator để dễ debug
          # Điều này sẽ capture output và error tốt hơn
          Write-Host "Launching Katalon process from: $projectPath"
          Write-Host "Command: $katalonExe $($katalonArgs -join ' ')"
          Write-Host ""
          
          # Chạy và capture output
          $output = & $katalonExe @katalonArgs 2>&1
          $exitCode = $LASTEXITCODE
          
          # Hiển thị output
          if ($output) {
            $output | ForEach-Object {
              if ($_ -is [System.Management.Automation.ErrorRecord]) {
                Write-Host $_.ToString() -ForegroundColor Red
              } else {
                Write-Host $_
              }
            }
          }
          
          # Nếu exit code null, set về 0
          if ($null -eq $exitCode) {
            $exitCode = 0
          }
          
        } catch {
          Write-Host "ERROR: Exception occurred while running Katalon" -ForegroundColor Red
          Write-Host $_.Exception.Message -ForegroundColor Red
          Write-Host $_.ScriptStackTrace -ForegroundColor Red
          $exitCode = 1
        } finally {
          # Quay lại thư mục ban đầu
          Pop-Location
        }
        
        # Để tương thích với code phía dưới
        $outputLines = @()
        $errorLines = @()
        if ($output) {
          $outputLines = $output | Where-Object { $_ -isnot [System.Management.Automation.ErrorRecord] }
          $errorLines = $output | Where-Object { $_ -is [System.Management.Automation.ErrorRecord] }
        }
        
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "Katalon execution finished"
        Write-Host "Exit code: $exitCode"
        Write-Host "=========================================="
        
        # Hiển thị output và error nếu có
        if ($outputLines.Count -gt 0) {
          Write-Host ""
          Write-Host "=== KATALON OUTPUT (last 50 lines) ===" -ForegroundColor Cyan
          $outputLines | Select-Object -Last 50 | ForEach-Object { Write-Host $_ }
        }
        
        if ($errorLines.Count -gt 0) {
          Write-Host ""
          Write-Host "=== KATALON ERRORS ===" -ForegroundColor Red
          $errorLines | ForEach-Object { Write-Host $_ -ForegroundColor Red }
        }
        
        # Kiểm tra log files của Katalon
        $logDirs = @(
          "$projectPath\Logs",
          "$env:USERPROFILE\.katalon\logs",
          "$KATALON_HOME\configuration\org.eclipse.osgi"
        )
        
        foreach ($logDir in $logDirs) {
          if (Test-Path $logDir) {
            Write-Host ""
            Write-Host "Checking for log files in: $logDir" -ForegroundColor Cyan
            $logFiles = Get-ChildItem -Path $logDir -Recurse -Filter "*.log" -ErrorAction SilentlyContinue | 
                        Sort-Object LastWriteTime -Descending | 
                        Select-Object -First 5
            if ($logFiles) {
              Write-Host "Found log files:" -ForegroundColor Yellow
              foreach ($logFile in $logFiles) {
                Write-Host "  - $($logFile.FullName) (Modified: $($logFile.LastWriteTime))"
                # Hiển thị 20 dòng cuối của log file
                try {
                  $logContent = Get-Content $logFile.FullName -Tail 20 -ErrorAction SilentlyContinue
                  if ($logContent) {
                    Write-Host "  Last 20 lines:" -ForegroundColor Gray
                    $logContent | ForEach-Object { Write-Host "    $_" -ForegroundColor Gray }
                  }
                } catch {
                  Write-Host "  Could not read log file" -ForegroundColor Yellow
                }
              }
            }
          }
        }
        
        # Kiểm tra kết quả
        if ($exitCode -ne 0) {
          Write-Host ""
          Write-Host "ERROR: Katalon exited with code $exitCode" -ForegroundColor Red
          Write-Host "Common exit codes:" -ForegroundColor Yellow
          Write-Host "  0 = Success"
          Write-Host "  1 = General error"
          Write-Host "  2 = Configuration/Project error"
          Write-Host "  3 = Test execution error"
          Write-Host ""
          Write-Host "Please check the logs above for details." -ForegroundColor Yellow
        } else {
          Write-Host ""
          Write-Host "SUCCESS: Tests completed successfully" -ForegroundColor Green
        }
        
        # Kiểm tra xem có reports không
        if (Test-Path "Reports") {
          $reportFiles = Get-ChildItem -Path "Reports" -Recurse -File
          Write-Host ""
          Write-Host "Found $($reportFiles.Count) report file(s):" -ForegroundColor Cyan
          $reportFiles | ForEach-Object {
            Write-Host "  - $($_.FullName)"
          }
        } else {
          Write-Host ""
          Write-Host "WARNING: Reports folder not found or empty" -ForegroundColor Yellow
        }
        
        # Exit với code tương ứng
        if ($exitCode -ne 0) {
          exit $exitCode
        }
          
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: Reports/**
        if-no-files-found: warn
        retention-days: 30
