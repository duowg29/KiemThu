name: Katalon Tests CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Cho phép chạy thủ công
  schedule:
    # Chạy mỗi ngày lúc 2:00 AM UTC (9:00 AM giờ Việt Nam)
    # Format: minute hour day-of-month month day-of-week
    # Để chạy 1 ngày 1 lần, uncomment dòng dưới:
    - cron: '0 2 * * *'  # 2:00 AM UTC mỗi ngày
    
    # Các ví dụ khác:
    # - cron: '0 9 * * *'  # 9:00 AM UTC mỗi ngày (4:00 PM giờ Việt Nam)
    # - cron: '0 0 * * *'  # Nửa đêm UTC mỗi ngày (7:00 AM giờ Việt Nam)
    # - cron: '0 14 * * 1-5'  # 2:00 PM UTC từ thứ 2 đến thứ 6 (9:00 PM giờ Việt Nam)
    # - cron: '0 */6 * * *'  # Mỗi 6 giờ một lần

jobs:
  run-katalon-tests:
    name: Run Katalon Studio Tests
    runs-on: windows-latest  # Hoặc self-hosted nếu bạn có runner với Katalon Studio
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: Download and Setup Katalon Studio
      if: runner.os == 'Windows'
      run: |
        # Tải Katalon Studio (nếu chưa có trên runner)
        # Hoặc sử dụng Katalon đã cài sẵn
        $KATALON_VERSION = "10.4.2"
        $KATALON_URL = "https://download.katalon.com/$KATALON_VERSION/katalon-studio-windows-64-$KATALON_VERSION.zip"
        
        # Nếu dùng self-hosted runner với Katalon đã cài, bỏ qua bước này
        # và set biến môi trường KATALON_HOME trỏ đến đường dẫn cài đặt
        
    - name: Run Katalon Tests
      timeout-minutes: 30
      env:
        JAVA_OPTS: '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dorg.eclipse.swt.browser.noDefault=true -Dkatalon.execution.report.enabled=false -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true'
        KATALON_OPTS: '-noSplash -noExit -consoleLog'
      run: |
        # Thay đổi đường dẫn này theo đường dẫn Katalon Studio trên runner của bạn
        # Option 1: Nếu cài trong Program Files
        $KATALON_HOME = "$env:ProgramFiles\Katalon\Katalon Studio"
        
        # Option 2: Nếu cài trong user directory (uncomment dòng này và comment dòng trên)
        # $KATALON_HOME = "$env:USERPROFILE\.katalon\packages\KSE-10.4.2"
        
        # Option 3: Nếu dùng đường dẫn tùy chỉnh (uncomment và sửa)
        # $KATALON_HOME = "C:\Path\To\Katalon\Studio"
        
        if (-not (Test-Path "$KATALON_HOME\katalon.exe")) {
          Write-Host "Katalon Studio not found at $KATALON_HOME"
          Write-Host "Please install Katalon Studio or use self-hosted runner with Katalon pre-installed"
          Write-Host "Or update the KATALON_HOME path in this workflow file"
          exit 1
        }
        
        Write-Host "Running Katalon Studio tests..."
        Write-Host "Katalon path: $KATALON_HOME\katalon.exe"
        Write-Host "Project path: $PWD"
        
        & "$KATALON_HOME\katalon.exe" -runMode=console `
          -projectPath="$PWD" `
          -retry=0 `
          -testSuitePath="Test Suites/Functional/Login Testcases" `
          -executionProfile="default" `
          -browserType="Chrome (headless)" `
          -apiKey="" `
          -g_username="" `
          -g_password=""
          
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Tests failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
          
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: Reports/**
        retention-days: 30

