name: Katalon Tests CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  run-katalon-tests:
    name: Run Katalon Studio Tests
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Katalon Tests
      timeout-minutes: 30
      env:
        JAVA_OPTS: '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true'
        KATALON_OPTS: '-noSplash -consoleLog'
      run: |
        # Đường dẫn Katalon
        $KATALON_HOME = "$env:USERPROFILE\.katalon\packages\KSE-10.4.2"
        
        if (-not (Test-Path "$KATALON_HOME\katalon.exe")) {
          Write-Host "Katalon not found at $KATALON_HOME"
          exit 1
        }
        
        # Ưu tiên dùng katalonc.exe (console-only, không mở GUI)
        $katalonExe = "$KATALON_HOME\katalonc.exe"
        if (-not (Test-Path $katalonExe)) {
          Write-Host "katalonc.exe not found, using katalon.exe instead"
          $katalonExe = "$KATALON_HOME\katalon.exe"
        } else {
          Write-Host "Using katalonc.exe (console-only mode)"
        }
        
        # Test suite và paths
        $testSuitePath = "Test Suites/UI/Navigation Testcases"
        $projectPath = $PWD -replace '\\', '/'
        $reportFolder = "$PWD\Reports" -replace '\\', '/'
        $baseUrl = "http://localhost/CAMNEST/"
        
        # Validate project path
        if (-not (Test-Path $projectPath)) {
          Write-Host "ERROR: Project path does not exist: $projectPath" -ForegroundColor Red
          exit 1
        }
        
        # Tìm test suite file (có thể có hoặc không có extension .ts)
        $testSuiteFullPath = Join-Path $projectPath $testSuitePath
        $testSuiteWithExt = "$testSuiteFullPath.ts"
        
        # Kiểm tra với extension .ts trước
        if (Test-Path $testSuiteWithExt) {
          $testSuiteFullPath = $testSuiteWithExt
          Write-Host "Found test suite with .ts extension: $testSuiteFullPath"
        } elseif (Test-Path $testSuiteFullPath) {
          Write-Host "Found test suite without extension: $testSuiteFullPath"
        } else {
          Write-Host "ERROR: Test suite path does not exist: $testSuiteFullPath" -ForegroundColor Red
          Write-Host "Also checked: $testSuiteWithExt" -ForegroundColor Yellow
          Write-Host "Available test suites:" -ForegroundColor Yellow
          $testSuitesDir = Join-Path $projectPath "Test Suites"
          if (Test-Path $testSuitesDir) {
            Get-ChildItem -Path $testSuitesDir -Recurse -Filter "*.ts" | ForEach-Object {
              $relativePath = $_.FullName.Replace($projectPath, '').TrimStart('\', '/')
              Write-Host "  - $relativePath"
            }
          }
          exit 1
        }
        
        # Format test suite path cho Katalon (relative path, không có extension .ts)
        # Katalon yêu cầu path không có extension
        $testSuitePathFormatted = $testSuitePath -replace '\\', '/'
        if ($testSuitePathFormatted.EndsWith('.ts')) {
          $testSuitePathFormatted = $testSuitePathFormatted.Substring(0, $testSuitePathFormatted.Length - 3)
        }
        
        # Validate project file
        $projectFile = Join-Path $projectPath "*.prj"
        $prjFiles = Get-ChildItem -Path $projectFile -ErrorAction SilentlyContinue
        if (-not $prjFiles) {
          Write-Host "WARNING: No .prj file found in project directory" -ForegroundColor Yellow
        } else {
          Write-Host "Found project file: $($prjFiles[0].Name)"
        }
        
        # Tạo thư mục Reports
        if (-not (Test-Path "Reports")) {
          New-Item -ItemType Directory -Path "Reports" -Force | Out-Null
        }
        
        Write-Host "=========================================="
        Write-Host "Running Katalon tests..."
        Write-Host "Project: $projectPath"
        Write-Host "Test Suite (for Katalon): $testSuitePathFormatted"
        Write-Host "Test Suite File Path: $testSuiteFullPath"
        Write-Host "Katalon Executable: $katalonExe"
        Write-Host "Report Folder: $reportFolder"
        Write-Host "Base URL: $baseUrl"
        Write-Host "=========================================="
        
        # Set environment variables trước khi chạy (đảm bảo headless)
        # Theo đề xuất: đảm bảo headless mode hoàn toàn
        $env:JAVA_OPTS = '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true'
        $env:KATALON_OPTS = '-noSplash -consoleLog'
        
        Write-Host "Environment variables set:"
        Write-Host "JAVA_OPTS: $env:JAVA_OPTS"
        Write-Host "KATALON_OPTS: $env:KATALON_OPTS"
        Write-Host ""
        
        # Xây dựng lệnh Katalon
        # QUAN TRỌNG: Khi dùng array với @ trong PowerShell, không cần quote trong array
        # PowerShell sẽ tự động escape spaces khi expand array
        # Browser type "Chrome (headless)" - không quote trong array, PowerShell sẽ tự xử lý
        # Dùng -data @noDefault để đảm bảo không dùng workspace mặc định (tránh GUI mode)
        # Lưu ý: -data phải đứng trước -runMode để đảm bảo workspace được set đúng
        $katalonArgs = @(
          '-data', '@noDefault'
          '-runMode=console'
          '-console'
          '-noSplash'
          '-consoleLog'
          "-projectPath=$projectPath"
          "-testSuitePath=$testSuitePathFormatted"
          '-executionProfile=default'
          '-browserType=Chrome (headless)'
          "-g_baseUrl=$baseUrl"
          "-reportFolder=$reportFolder"
          '-retry=0'
        )
        
        Write-Host "Starting Katalon execution..."
        Write-Host "Note: This may take a while on slower machines. Please wait..."
        Write-Host ""
        
        # Chuyển đến thư mục project trước khi chạy
        Push-Location $projectPath
        
        try {
          Write-Host "Launching Katalon process from: $projectPath"
          Write-Host "Executable: $katalonExe"
          Write-Host "Arguments: $($katalonArgs -join ' ')"
          Write-Host ""
          Write-Host "Starting Katalon execution (headless mode - NO GUI)..."
          Write-Host "This may take a while on slower machines. Please wait..."
          Write-Host ""
          
          # Thử cách đơn giản hơn trước: chạy trực tiếp với & để xem output ngay
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Attempting direct execution to capture immediate output..." -ForegroundColor Yellow
          
          $directOutput = @()
          $directErrors = @()
          $directExitCode = $null
          
          try {
            # Chạy trực tiếp để xem output ngay
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Executing Katalon directly..." -ForegroundColor Green
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Command: $katalonExe $($katalonArgs -join ' ')" -ForegroundColor Gray
            Write-Host ""
            
            # Capture output
            $script:output = New-Object System.Collections.ArrayList
            $script:errors = New-Object System.Collections.ArrayList
            
            # Chạy và capture tất cả output (cả stdout và stderr)
            # QUAN TRỌNG: Dùng Start-Process với CreateNoWindow để đảm bảo không mở GUI
            # Format arguments đúng cách: -data và @noDefault phải là một argument duy nhất
            $processInfo = New-Object System.Diagnostics.ProcessStartInfo
            $processInfo.FileName = $katalonExe
            # Build arguments string manually để đảm bảo format đúng
            $argList = New-Object System.Collections.Generic.List[string]
            foreach ($arg in $katalonArgs) {
                if ($arg -eq '-data') {
                    # Skip -data, sẽ thêm cùng với @noDefault
                    continue
                } elseif ($arg -eq '@noDefault') {
                    # Combine -data và @noDefault thành một argument
                    $argList.Add('-data @noDefault')
                } else {
                    $argList.Add($arg)
                }
            }
            $processInfo.Arguments = $argList -join ' '
            $processInfo.UseShellExecute = $false
            $processInfo.RedirectStandardOutput = $true
            $processInfo.RedirectStandardError = $true
            $processInfo.CreateNoWindow = $true
            $processInfo.WorkingDirectory = $projectPath
            
            # Set environment variables
            $processInfo.EnvironmentVariables['JAVA_OPTS'] = $env:JAVA_OPTS
            $processInfo.EnvironmentVariables['KATALON_OPTS'] = $env:KATALON_OPTS
            
            $process = New-Object System.Diagnostics.Process
            $process.StartInfo = $processInfo
            
            # Capture output
            $outputBuilder = New-Object System.Text.StringBuilder
            $errorBuilder = New-Object System.Text.StringBuilder
            
            $outputEvent = Register-ObjectEvent -InputObject $process -EventName OutputDataReceived -Action {
                if ($EventArgs.Data) {
                    [void]$Event.MessageData.AppendLine($EventArgs.Data)
                }
            } -MessageData $outputBuilder
            
            $errorEvent = Register-ObjectEvent -InputObject $process -EventName ErrorDataReceived -Action {
                if ($EventArgs.Data) {
                    [void]$Event.MessageData.AppendLine($EventArgs.Data)
                }
            } -MessageData $errorBuilder
            
            $process.Start() | Out-Null
            $process.BeginOutputReadLine()
            $process.BeginErrorReadLine()
            
            # Đợi process hoàn thành (timeout 30 phút)
            $process.WaitForExit(1800000)
            
            if (-not $process.HasExited) {
                Write-Host "[WARNING] Process timeout, killing..." -ForegroundColor Yellow
                $process.Kill()
                $directExitCode = 1
            } else {
                $directExitCode = $process.ExitCode
            }
            
            # Lấy output
            $allDirectOutput = $outputBuilder.ToString() -split "`n"
            $allDirectErrors = $errorBuilder.ToString() -split "`n"
            
            # Cleanup events
            Unregister-Event -SourceIdentifier $outputEvent.Name -ErrorAction SilentlyContinue
            Unregister-Event -SourceIdentifier $errorEvent.Name -ErrorAction SilentlyContinue
            
            # Phân loại output - xử lý từng dòng
            if ($allDirectOutput) {
              foreach ($line in $allDirectOutput) {
                if ($null -ne $line -and $line.Trim() -ne '') {
                  [void]$script:output.Add($line)
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] $line"
                }
              }
            }
            
            # Xử lý errors
            if ($allDirectErrors) {
              foreach ($line in $allDirectErrors) {
                if ($null -ne $line -and $line.Trim() -ne '') {
                  [void]$script:errors.Add($line)
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ERROR: $line" -ForegroundColor Red
                }
              }
            }
            
            if ($null -eq $directExitCode) {
              $directExitCode = 0
            }
            
            $exitCode = $directExitCode
            
            Write-Host ""
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Direct execution completed with exit code: $exitCode" -ForegroundColor Green
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Output lines: $($script:output.Count), Error lines: $($script:errors.Count)" -ForegroundColor Gray
            
            # Nếu không có output nhưng có exit code lỗi, cảnh báo
            if ($script:output.Count -eq 0 -and $exitCode -ne 0) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WARNING: No output captured but exit code is $exitCode" -ForegroundColor Yellow
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] This might indicate Katalon failed to start or output was not captured" -ForegroundColor Yellow
            }
            
          } catch {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Direct execution exception: $($_.Exception.Message)" -ForegroundColor Yellow
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Trying Start-Process method as fallback..." -ForegroundColor Yellow
            
            # Fallback: Dùng Start-Process với CreateNoWindow để đảm bảo KHÔNG mở GUI
            $processInfo = New-Object System.Diagnostics.ProcessStartInfo
            $processInfo.FileName = $katalonExe
            $processInfo.Arguments = $katalonArgs -join ' '
            $processInfo.UseShellExecute = $false
            $processInfo.RedirectStandardOutput = $true
            $processInfo.RedirectStandardError = $true
            $processInfo.CreateNoWindow = $true  # QUAN TRỌNG: Không tạo cửa sổ
            $processInfo.WorkingDirectory = $projectPath
            
            # Set environment variables
            $processInfo.EnvironmentVariables['JAVA_OPTS'] = $env:JAVA_OPTS
            $processInfo.EnvironmentVariables['KATALON_OPTS'] = $env:KATALON_OPTS
            
            $process = New-Object System.Diagnostics.Process
            $process.StartInfo = $processInfo
            
            # Capture output real-time
            $script:output = New-Object System.Collections.ArrayList
            $script:errors = New-Object System.Collections.ArrayList
            $script:lastOutputTime = Get-Date
            
            # Event handlers để capture output real-time
            $outputHandler = {
              param($sender, $e)
              if ($e.Data) {
                $line = $e.Data
                [void]$script:output.Add($line)
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] $line" -ForegroundColor Cyan
                $script:lastOutputTime = Get-Date
              }
            }
            
            $errorHandler = {
              param($sender, $e)
              if ($e.Data) {
                $line = $e.Data
                [void]$script:errors.Add($line)
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ERROR: $line" -ForegroundColor Red
                $script:lastOutputTime = Get-Date
              }
            }
            
            $process.add_OutputDataReceived($outputHandler)
            $process.add_ErrorDataReceived($errorHandler)
            
            # Bắt đầu process
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Starting Katalon process..." -ForegroundColor Green
            
            try {
              $process.Start() | Out-Null
            } catch {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ERROR: Failed to start process" -ForegroundColor Red
              Write-Host "Exception: $($_.Exception.Message)" -ForegroundColor Red
              throw
            }
            
            $process.BeginOutputReadLine()
            $process.BeginErrorReadLine()
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process started (PID: $($process.Id))" -ForegroundColor Green
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Waiting for initial output (10 seconds)..." -ForegroundColor Yellow
            
            # Đợi một chút để xem có output ban đầu không
            Start-Sleep -Seconds 10
            
            # Kiểm tra xem process có còn chạy không
            if ($process.HasExited) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WARNING: Process exited very quickly (within 10 seconds)" -ForegroundColor Yellow
              $exitCode = $process.ExitCode
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Exit code: $exitCode" -ForegroundColor Yellow
            } else {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process is still running. Monitoring..." -ForegroundColor Green
              Write-Host ""
              
              # Monitor process với timeout và progress updates
              $timeoutMinutes = 25
              $timeoutSeconds = $timeoutMinutes * 60
              $startTime = Get-Date
              $lastStatusTime = Get-Date
              $noOutputTimeout = 300  # 5 phút không có output = có thể treo
              
              while (-not $process.HasExited) {
                $elapsed = (Get-Date) - $startTime
                $elapsedSeconds = [int]$elapsed.TotalSeconds
                
                # Kiểm tra timeout tổng
                if ($elapsedSeconds -ge $timeoutSeconds) {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] TIMEOUT: Process exceeded $timeoutMinutes minutes" -ForegroundColor Red
                  $process.Kill()
                  $exitCode = 1
                  break
                }
                
                # Kiểm tra timeout không có output
                $timeSinceLastOutput = (Get-Date) - $script:lastOutputTime
                if ($timeSinceLastOutput.TotalSeconds -ge $noOutputTimeout) {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WARNING: No output for $noOutputTimeout seconds. Process may be hung." -ForegroundColor Yellow
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process is still running (PID: $($process.Id)). Checking if it's responsive..." -ForegroundColor Yellow
                }
                
                # Status update mỗi 30 giây
                $timeSinceLastStatus = (Get-Date) - $lastStatusTime
                if ($timeSinceLastStatus.TotalSeconds -ge 30) {
                  $minutes = [int]($elapsed.TotalMinutes)
                  $seconds = [int]($elapsed.TotalSeconds % 60)
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Status: Still running... (Elapsed: ${minutes}m ${seconds}s, PID: $($process.Id), Output lines: $($script:output.Count))" -ForegroundColor Gray
                  $lastStatusTime = Get-Date
                }
                
                Start-Sleep -Seconds 2
              }
              
              # Đợi một chút để capture output cuối cùng
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process exited. Waiting for final output (5 seconds)..." -ForegroundColor Yellow
              Start-Sleep -Seconds 5
              
              if (-not $process.HasExited) {
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process did not exit properly. Forcing termination..." -ForegroundColor Red
                $process.Kill()
                $exitCode = 1
              } else {
                $exitCode = $process.ExitCode
                $elapsed = (Get-Date) - $startTime
                $minutes = [int]($elapsed.TotalMinutes)
                $seconds = [int]($elapsed.TotalSeconds % 60)
                Write-Host ""
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Process completed (Exit code: $exitCode, Duration: ${minutes}m ${seconds}s)" -ForegroundColor Green
              }
            }
            
            # Đảm bảo output được flush
            Start-Sleep -Seconds 2
            
            # Nếu exit code null, set về 0
            if ($null -eq $exitCode) {
              $exitCode = 0
            }
            
            # Hiển thị summary
            Write-Host ""
            Write-Host "=== EXECUTION SUMMARY ===" -ForegroundColor Cyan
            Write-Host "Output lines captured: $($script:output.Count)"
            Write-Host "Error lines captured: $($script:errors.Count)"
            Write-Host "Exit code: $exitCode"
            Write-Host ""
            
          # Hiển thị output nếu có
          if ($script:output.Count -gt 0) {
            Write-Host "=== KATALON OUTPUT (ALL $($script:output.Count) lines) ===" -ForegroundColor Cyan
            $script:output | ForEach-Object {
              Write-Host $_
            }
          } else {
            Write-Host "WARNING: No output captured from Katalon!" -ForegroundColor Yellow
            Write-Host "This might indicate:" -ForegroundColor Yellow
            Write-Host "  1. Process exited too quickly" -ForegroundColor Yellow
            Write-Host "  2. Output was not redirected properly" -ForegroundColor Yellow
            Write-Host "  3. Katalon failed to start" -ForegroundColor Yellow
            Write-Host ""
            Write-Host "Attempting to check Katalon logs..." -ForegroundColor Yellow
            
            # Kiểm tra log files của Katalon
            $logPaths = @(
              "$projectPath\Logs",
              "$env:USERPROFILE\.katalon\logs",
              "$KATALON_HOME\configuration\org.eclipse.osgi",
              "$env:USERPROFILE\.katalon\workspace\.metadata\.log"
            )
            
            foreach ($logPath in $logPaths) {
              if (Test-Path $logPath) {
                Write-Host "Checking: $logPath" -ForegroundColor Gray
                $logFiles = Get-ChildItem -Path $logPath -Recurse -Filter "*.log" -ErrorAction SilentlyContinue | 
                            Sort-Object LastWriteTime -Descending | 
                            Select-Object -First 3
                if ($logFiles) {
                  Write-Host "Found log files:" -ForegroundColor Green
                  foreach ($logFile in $logFiles) {
                    Write-Host "  - $($logFile.FullName) (Modified: $($logFile.LastWriteTime))" -ForegroundColor Green
                    try {
                      $logContent = Get-Content $logFile.FullName -Tail 30 -ErrorAction SilentlyContinue
                      if ($logContent) {
                        Write-Host "  Last 30 lines:" -ForegroundColor Cyan
                        $logContent | ForEach-Object { Write-Host "    $_" -ForegroundColor Gray }
                      }
                    } catch {
                      Write-Host "  Could not read log file" -ForegroundColor Yellow
                    }
                  }
                }
              }
            }
          }
            
            if ($script:errors.Count -gt 0) {
              Write-Host ""
              Write-Host "=== ERRORS CAPTURED ===" -ForegroundColor Red
              $script:errors | ForEach-Object {
                Write-Host $_ -ForegroundColor Red
              }
            }
            
            # Nếu exit code 2, hiển thị thông tin thêm
            if ($exitCode -eq 2) {
              Write-Host ""
              Write-Host "=== EXIT CODE 2 ANALYSIS ===" -ForegroundColor Yellow
              Write-Host "Exit code 2 typically means:" -ForegroundColor Yellow
              Write-Host "  - Configuration/Project error" -ForegroundColor Yellow
              Write-Host "  - Invalid project path or test suite path" -ForegroundColor Yellow
              Write-Host "  - Missing required files or dependencies" -ForegroundColor Yellow
              Write-Host ""
              Write-Host "Please check:" -ForegroundColor Yellow
              Write-Host "  1. Project path: $projectPath" -ForegroundColor Yellow
              Write-Host "  2. Test suite path: $testSuitePathFormatted" -ForegroundColor Yellow
              Write-Host "  3. Katalon executable: $katalonExe" -ForegroundColor Yellow
              Write-Host "  4. Check if project file (.prj) exists" -ForegroundColor Yellow
            }
            
            # Để tương thích với code phía dưới
            $outputLines = $script:output
            $errorLines = $script:errors
          } # End of catch block for direct execution fallback
          
        } catch {
          Write-Host ""
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ERROR: Exception occurred while running Katalon" -ForegroundColor Red
          Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
          Write-Host "Exception Type: $($_.Exception.GetType().FullName)" -ForegroundColor Red
          Write-Host "Script Stack Trace:" -ForegroundColor Red
          Write-Host $_.ScriptStackTrace -ForegroundColor Red
          if ($_.Exception.InnerException) {
            Write-Host "Inner Exception: $($_.Exception.InnerException.Message)" -ForegroundColor Red
          }
          $exitCode = 1
        } finally {
          # Quay lại thư mục ban đầu
          Pop-Location
        }
        
        # Đảm bảo biến tồn tại cho code phía dưới
        if (-not (Get-Variable -Name 'outputLines' -ErrorAction SilentlyContinue)) {
          $outputLines = @()
        }
        if (-not (Get-Variable -Name 'errorLines' -ErrorAction SilentlyContinue)) {
          $errorLines = @()
        }
        
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "Katalon execution finished"
        Write-Host "Exit code: $exitCode"
        Write-Host "=========================================="
        
        # Hiển thị output và error nếu có
        if ($outputLines.Count -gt 0) {
          Write-Host ""
          Write-Host "=== KATALON OUTPUT (last 50 lines) ===" -ForegroundColor Cyan
          $outputLines | Select-Object -Last 50 | ForEach-Object { Write-Host $_ }
        }
        
        if ($errorLines.Count -gt 0) {
          Write-Host ""
          Write-Host "=== KATALON ERRORS ===" -ForegroundColor Red
          $errorLines | ForEach-Object { Write-Host $_ -ForegroundColor Red }
        }
        
        # Kiểm tra log files của Katalon
        $logDirs = @(
          "$projectPath\Logs",
          "$env:USERPROFILE\.katalon\logs",
          "$KATALON_HOME\configuration\org.eclipse.osgi"
        )
        
        foreach ($logDir in $logDirs) {
          if (Test-Path $logDir) {
            Write-Host ""
            Write-Host "Checking for log files in: $logDir" -ForegroundColor Cyan
            $logFiles = Get-ChildItem -Path $logDir -Recurse -Filter "*.log" -ErrorAction SilentlyContinue | 
                        Sort-Object LastWriteTime -Descending | 
                        Select-Object -First 5
            if ($logFiles) {
              Write-Host "Found log files:" -ForegroundColor Yellow
              foreach ($logFile in $logFiles) {
                Write-Host "  - $($logFile.FullName) (Modified: $($logFile.LastWriteTime))"
                # Hiển thị 20 dòng cuối của log file
                try {
                  $logContent = Get-Content $logFile.FullName -Tail 20 -ErrorAction SilentlyContinue
                  if ($logContent) {
                    Write-Host "  Last 20 lines:" -ForegroundColor Gray
                    $logContent | ForEach-Object { Write-Host "    $_" -ForegroundColor Gray }
                  }
                } catch {
                  Write-Host "  Could not read log file" -ForegroundColor Yellow
                }
              }
            }
          }
        }
        
        # Kiểm tra kết quả
        if ($exitCode -ne 0) {
          Write-Host ""
          Write-Host "ERROR: Katalon exited with code $exitCode" -ForegroundColor Red
          Write-Host "Common exit codes:" -ForegroundColor Yellow
          Write-Host "  0 = Success"
          Write-Host "  1 = General error"
          Write-Host "  2 = Configuration/Project error"
          Write-Host "  3 = Test execution error"
          Write-Host ""
          Write-Host "Please check the logs above for details." -ForegroundColor Yellow
        } else {
          Write-Host ""
          Write-Host "SUCCESS: Tests completed successfully" -ForegroundColor Green
        }
        
        # Kiểm tra xem có reports không
        if (Test-Path "Reports") {
          $reportFiles = Get-ChildItem -Path "Reports" -Recurse -File
          Write-Host ""
          Write-Host "Found $($reportFiles.Count) report file(s):" -ForegroundColor Cyan
          $reportFiles | ForEach-Object {
            Write-Host "  - $($_.FullName)"
          }
        } else {
          Write-Host ""
          Write-Host "WARNING: Reports folder not found or empty" -ForegroundColor Yellow
        }
        
        # Exit với code tương ứng
        if ($exitCode -ne 0) {
          exit $exitCode
        }
          
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: Reports/**
        if-no-files-found: warn
        retention-days: 30
