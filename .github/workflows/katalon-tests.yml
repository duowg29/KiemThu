name: Katalon Tests CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  run-katalon-tests:
    name: Run Katalon Studio Tests
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Katalon Tests
      timeout-minutes: 30
      env:
        JAVA_OPTS: '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dkatalon.webview.enabled=false'
        KATALON_OPTS: '-noSplash -consoleLog'
      run: |
        # Đường dẫn Katalon
        $KATALON_HOME = "$env:USERPROFILE\.katalon\packages\KSE-10.4.2"
        
        if (-not (Test-Path "$KATALON_HOME\katalon.exe")) {
          Write-Host "Katalon not found at $KATALON_HOME"
          exit 1
        }
        
        # Dùng katalonc.exe nếu có (console-only)
        $katalonExe = "$KATALON_HOME\katalon.exe"
        if (Test-Path "$KATALON_HOME\katalonc.exe") {
          $katalonExe = "$KATALON_HOME\katalonc.exe"
        }
        
        # Test suite và paths
        $testSuitePath = "Test Suites/UI/Navigation Testcases"
        $projectPath = $PWD -replace '\\', '/'
        $testSuitePathFormatted = $testSuitePath -replace '\\', '/'
        $reportFolder = "$PWD\Reports" -replace '\\', '/'
        $baseUrl = "http://localhost/CAMNEST/"
        
        # Tạo thư mục Reports
        if (-not (Test-Path "Reports")) {
          New-Item -ItemType Directory -Path "Reports" -Force | Out-Null
        }
        
        Write-Host "Running Katalon tests..."
        Write-Host "Project: $projectPath"
        Write-Host "Test Suite: $testSuitePath"
        
        # Chạy Katalon
        & $katalonExe `
          -runMode=console `
          -console `
          -noSplash `
          -consoleLog `
          -projectPath="$projectPath" `
          -testSuitePath="$testSuitePathFormatted" `
          -executionProfile=default `
          -browserType="Chrome (headless)" `
          -g_baseUrl="$baseUrl" `
          -reportFolder="$reportFolder"
        
        $exitCode = $LASTEXITCODE
        if ($null -eq $exitCode) { $exitCode = 0 }
        
        Write-Host "Tests completed with exit code: $exitCode"
          
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: Reports/**
        if-no-files-found: warn
        retention-days: 30
