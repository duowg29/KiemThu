name: Katalon Tests CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Cho phép chạy thủ công
  schedule:
    # Chạy mỗi ngày lúc 2:00 AM UTC (9:00 AM giờ Việt Nam)
    # Format: minute hour day-of-month month day-of-week
    # Để chạy 1 ngày 1 lần, uncomment dòng dưới:
    - cron: '0 2 * * *'  # 2:00 AM UTC mỗi ngày
    
    # Các ví dụ khác:
    # - cron: '0 9 * * *'  # 9:00 AM UTC mỗi ngày (4:00 PM giờ Việt Nam)
    # - cron: '0 0 * * *'  # Nửa đêm UTC mỗi ngày (7:00 AM giờ Việt Nam)
    # - cron: '0 14 * * 1-5'  # 2:00 PM UTC từ thứ 2 đến thứ 6 (9:00 PM giờ Việt Nam)
    # - cron: '0 */6 * * *'  # Mỗi 6 giờ một lần

jobs:
  run-katalon-tests:
    name: Run Katalon Studio Tests
    runs-on: self-hosted  # YÊU CẦU: Phải có self-hosted runner đã setup
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Katalon Tests
      timeout-minutes: 30
      env:
        JAVA_OPTS: '-Djava.awt.headless=true -Dorg.eclipse.swt.browser.DefaultType=none -Dorg.eclipse.swt.browser.noDefault=true -Dkatalon.webview.enabled=false -Dorg.eclipse.swt.browser.chromium.enabled=false -Declipse.e4.inject.javax.disabled=true'
        KATALON_OPTS: '-noSplash -noExit -consoleLog'
      run: |
        # Thay đổi đường dẫn này theo đường dẫn Katalon Studio trên runner của bạn
        # Option 1: Nếu cài trong Program Files
        # $KATALON_HOME = "$env:ProgramFiles\Katalon\Katalon Studio"
        
        # Option 2: Nếu cài trong user directory (uncomment dòng này và comment dòng trên)
         $KATALON_HOME = "$env:USERPROFILE\.katalon\packages\KSE-10.4.2"
        
        # Option 3: Nếu dùng đường dẫn tùy chỉnh (uncomment và sửa)
        # $KATALON_HOME = "C:\Path\To\Katalon\Studio"
        
        if (-not (Test-Path "$KATALON_HOME\katalon.exe")) {
          Write-Host "Katalon Studio not found at $KATALON_HOME"
          Write-Host "Please install Katalon Studio or use self-hosted runner with Katalon pre-installed"
          Write-Host "Or update the KATALON_HOME path in this workflow file"
          exit 1
        }
        
        Write-Host "Running Katalon Studio tests..."
        Write-Host "Katalon path: $KATALON_HOME\katalon.exe"
        Write-Host "Project path: $PWD"
        
        # Dùng test suite cụ thể thay vì collection (collection có thể không chạy được trong console mode)
        $testSuitePath = "Test Suites/UI/Login Testcases"
        
        # Kiểm tra test suite có tồn tại không
        if (-not (Test-Path "$PWD\$testSuitePath.ts")) {
          Write-Host "WARNING: Test suite file not found at $PWD\$testSuitePath.ts"
          Write-Host "Trying alternative path..."
          # Thử không có extension
          if (Test-Path "$PWD\$testSuitePath") {
            Write-Host "Found test suite without extension"
          } else {
            Write-Host "Listing available test suites:"
            Get-ChildItem -Path "$PWD\Test Suites" -Recurse -Filter "*.ts" | Where-Object { $_.Name -notlike "*Testing.ts" } | ForEach-Object {
              Write-Host "  $($_.FullName.Replace($PWD, '.'))"
            }
            Write-Host "NOTE: Test suite collections (*Testing.ts) may not work in console mode."
            Write-Host "Use specific test suites instead (e.g., Login Testcases, Signup Testcases)"
          }
        } else {
          Write-Host "Test suite found: $PWD\$testSuitePath.ts"
        }
        
        Write-Host "Starting Katalon execution..."
        Write-Host "Command: $KATALON_HOME\katalon.exe -runMode=console -projectPath=`"$PWD`" -testSuitePath=`"$testSuitePath`" -executionProfile=`"default`" -browserType=`"Chrome (headless)`" -reportFolder=`"$PWD\Reports`""
        $startTime = Get-Date
        
        # Chạy Katalon với output chi tiết và capture output
        $output = & "$KATALON_HOME\katalon.exe" -runMode=console `
          -projectPath="$PWD" `
          -retry=0 `
          -testSuitePath="$testSuitePath" `
          -executionProfile="default" `
          -browserType="Chrome (headless)" `
          -apiKey="" `
          -g_username="" `
          -g_password="" `
          -reportFolder="$PWD\Reports" `
          2>&1
        
        # Hiển thị output
        $output | ForEach-Object {
          Write-Host $_
        }
        
        $endTime = Get-Date
        $duration = $endTime - $startTime
        Write-Host "=========================================="
        Write-Host "Katalon execution completed in $($duration.TotalSeconds) seconds"
        Write-Host "Exit code: $LASTEXITCODE"
        Write-Host "=========================================="
        
        # Kiểm tra nếu chạy quá nhanh (có thể test không chạy)
        if ($duration.TotalSeconds -lt 10) {
          Write-Host "WARNING: Test completed too quickly ($($duration.TotalSeconds) seconds)."
          Write-Host "This may indicate that tests did not actually run."
          Write-Host "Check the output above for any errors."
        }
          
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Tests failed with exit code $LASTEXITCODE"
          # Không exit ngay, để tìm reports trước
        }
        
        Write-Host "Finding test reports..."
        Write-Host "Current directory: $PWD"
        
        # Tạo thư mục Reports nếu chưa có
        if (-not (Test-Path "Reports")) {
          New-Item -ItemType Directory -Path "Reports" -Force | Out-Null
          Write-Host "Created Reports directory"
        }
        
        # Tìm tất cả reports trong project và workspace
        Write-Host "Searching for reports in project directory..."
        Get-ChildItem -Path $PWD -Recurse -Directory -Filter "Reports" -ErrorAction SilentlyContinue | ForEach-Object {
          Write-Host "Found Reports folder at: $($_.FullName)"
          $files = Get-ChildItem -Path $_.FullName -Recurse -File -ErrorAction SilentlyContinue
          Write-Host "  Found $($files.Count) files"
        }
        
        # Tìm trong thư mục workspace của runner (có thể Katalon tạo reports ở đó)
        $workspacePath = $env:GITHUB_WORKSPACE
        if ($workspacePath) {
          Write-Host "Searching in workspace: $workspacePath"
          Get-ChildItem -Path $workspacePath -Recurse -Directory -Filter "Reports" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "Found Reports in workspace at: $($_.FullName)"
          }
        }
        
        # List tất cả files trong Reports
        if (Test-Path "Reports") {
          Write-Host "Contents of Reports folder:"
          $reportFiles = Get-ChildItem -Path "Reports" -Recurse -ErrorAction SilentlyContinue
          if ($reportFiles.Count -eq 0) {
            Write-Host "  (empty)"
          } else {
            $reportFiles | ForEach-Object {
              Write-Host "  $($_.FullName)"
            }
          }
        } else {
          Write-Host "Reports folder not found in project root"
        }
        
        # Tìm reports trong thư mục Katalon workspace (có thể reports được tạo ở đó)
        $katalonWorkspace = "$env:USERPROFILE\.katalon\packages\KSE-10.4.2\workspace"
        if (Test-Path $katalonWorkspace) {
          Write-Host "Searching in Katalon workspace: $katalonWorkspace"
          Get-ChildItem -Path $katalonWorkspace -Recurse -Directory -Filter "Reports" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "Found Reports in workspace at: $($_.FullName)"
            # Copy reports về project nếu tìm thấy
            Copy-Item -Path "$($_.FullName)\*" -Destination "Reports\" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "Copied reports to project Reports folder"
          }
        }
        
        # Nếu vẫn không có reports và test chạy quá nhanh, có thể test không chạy
        if (-not (Test-Path "Reports") -or (Get-ChildItem -Path "Reports" -Recurse -ErrorAction SilentlyContinue).Count -eq 0) {
          Write-Host "WARNING: No reports found. Test may not have executed properly."
          Write-Host "Check if test suite path is correct and contains test cases."
        }
          
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          Reports/**
          **/Reports/**
          **/*.html
          **/*.xml
          **/*.json
        if-no-files-found: warn
        retention-days: 30

